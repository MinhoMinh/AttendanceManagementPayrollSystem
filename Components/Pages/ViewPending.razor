@page "/viewpending"
@using AttendanceManagementPayrollSystem.DTO
@using System.Text.Json
@inject IHttpClientFactory ClientFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="page-wrapper">
    <div class="pending-card">
        <h3>Pending Leave Requests</h3>

        @if (isLoading)
        {
            <p>Loading...</p>
        }
        else if (requests == null || !requests.Any())
        {
            <p>No pending requests.</p>
        }
        else
        {
            <table class="pending-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Employee ID</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var (r, index) in requests.Select((value, i) => (value, i + 1)))
                    {
                        <tr class="@GetStatusClass(r.Status)">
                            <td>@index</td>
                            <td>@r.EmpId</td>
                            <td>@r.StartDate.ToShortDateString()</td>
                            <td>@r.EndDate.ToShortDateString()</td>
                            <td>@r.Reason</td>
                            <td>@r.Status</td>
                            <td>
                                <button class="btn-approve" @onclick='() => UpdateStatusAsync(r.ReqId, "Approved")'>Approve</button>
                                <button class="btn-reject" @onclick='() => UpdateStatusAsync(r.ReqId, "Rejected")'>Reject</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-box">@errorMessage</div>
        }
    </div>
</div>

@code {
    private List<LeaveRequestDTO>? requests;
    private bool isLoading = true;
    private string errorMessage = string.Empty;
    private EmployeeDTO? Employee;


    protected override async Task OnInitializedAsync()
    {
        var empJson = await JS.InvokeAsync<string>("localStorage.getItem", "employee");
        if (string.IsNullOrWhiteSpace(empJson)) return;

        Employee = JsonSerializer.Deserialize<EmployeeDTO>(empJson);
        await LoadPendingRequestsAsync();
    }

    private async Task LoadPendingRequestsAsync()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var client = ClientFactory.CreateClient("ApiClient");
            requests = await client.GetFromJsonAsync<List<LeaveRequestDTO>>("api/LeaveRequest/pending");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateStatusAsync(int id, string status)
    {
        try
        {
            var client = ClientFactory.CreateClient("ApiClient");
            var dto = new LeaveRequestStatusDTO { ReqId = id, Status = status, ApprovedBy = Employee.EmpId};
            var res = await client.PutAsJsonAsync("api/LeaveRequest/update-status", dto);

            if (res.IsSuccessStatusCode)
            {
                await LoadPendingRequestsAsync();
            }
            else
            {
                errorMessage = $"Update failed: {res.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating: {ex.Message}";
        }
    }

    private string GetStatusClass(string? status) => status?.ToLower() switch
    {
        "approved" => "status-approved",
        "rejected" => "status-rejected",
        _ => "status-pending"
    };
}
