@page "/edit-insurance"
@using AttendanceManagementPayrollSystem.DTO
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Navigation
@using System.Globalization

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<h3 class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
    <span>Lịch sử tỷ lệ bảo hiểm</span>
    <button class="btn btn-sm btn-outline-secondary" @onclick="BackToRatesTax">
        <i class="bi bi-arrow-left"></i> Quay lại
    </button>
</h3>

@if (insuranceList == null)
{
    <p><em>Đang tải dữ liệu tỷ lệ bảo hiểm...</em></p>
}
else
{
    @if (!string.IsNullOrEmpty(successMessage) && showToast)
    {
        <div class="toast-fixed">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> @successMessage
                <button type="button" class="btn-close" @onclick="() => showToast = false"></button>
            </div>
        </div>
    }

    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Tên loại</th>
                <th>Tỷ lệ nhân viên</th>
                <th>Tỷ lệ công ty</th>
                <th>Quy tắc trần</th>
                <th>Hiệu lực từ</th>
                <th>Hiệu lực đến</th>
                <th>Mã luật</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in insuranceList)
            {
                bool isCurrentlyActive = activeIds.Contains(item.RateSetId);

                <tr class="@(isCurrentlyActive ? "table-success" : "")">
                    @if (isEditing && selectedItem?.RateSetId == item.RateSetId)
                    {
                        <!-- Dòng đang chỉnh sửa -->
                        <td><InputText @bind-Value="editModel.TypeName" class="form-control" /></td>
                        <td><InputNumber @bind-Value="editModel.EmployeeRate" class="form-control" /></td>
                        <td><InputNumber @bind-Value="editModel.EmployerRate" class="form-control" /></td>
                        <td><InputText @bind-Value="editModel.CapRule" class="form-control" /></td>
                        <td><InputDate @bind-Value="editModel.EffectiveFrom" class="form-control" /></td>
                        <td><InputDate @bind-Value="editModel.EffectiveTo" class="form-control" /></td>
                        <td><InputText @bind-Value="editModel.LawCode" class="form-control" /></td>
                        <td>
                            <InputCheckbox @bind-Value="editModel.IsActive" />
                        </td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-success me-1" @onclick="SaveEdit">
                                <i class="bi bi-check-lg"></i> Lưu
                            </button>
                            <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">
                                <i class="bi bi-x-lg"></i> Hủy
                            </button>
                        </td>
                    }
                    else
                    {
                        <!-- Dòng bình thường -->
                        <td>@item.TypeName</td>
                        <td>@(item.EmployeeRate * 100)%</td>
                        <td>@(item.EmployerRate * 100)%</td>
                        <td>@item.CapRule</td>
                        <td>@item.EffectiveFrom.ToString("yyyy-MM-dd")</td>
                        <td>@(item.EffectiveTo?.ToString("yyyy-MM-dd") ?? "—")</td>
                        <td>@item.LawCode</td>
                        <td>@(item.IsActive ? "Đang hoạt động" : "Ngừng hoạt động")</td>
                        <td>
                            @if (isCurrentlyActive)
                            {
                                <button class="btn btn-sm btn-outline-primary"
                                        @onclick="() => StartEdit(item)">
                                    <i class="bi bi-pencil-square"></i> Sửa
                                </button>
                            }
                            else
                            {
                                <span class="text-muted small">—</span>
                            }
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<InsuranceRateDTO>? insuranceList;
    private InsuranceRateDTO? selectedItem;
    private InsuranceRateEditDTO editModel = new();
    private bool isEditing = false;
    private List<int> activeIds = new List<int>();
    private string? successMessage;
    private bool showToast = false;

    protected override async Task OnInitializedAsync()
    {
        var client = HttpFactory.CreateClient("ApiClient");
        insuranceList = await client.GetFromJsonAsync<List<InsuranceRateDTO>>("api/insurancerateset");
        activeIds = await client.GetFromJsonAsync<List<int>>("api/insurancerateset/active/ids");
    }

    private void StartEdit(InsuranceRateDTO item)
    {
        selectedItem = item;
        editModel = new InsuranceRateEditDTO
        {
            RateSetId = item.RateSetId,
            TypeName = item.TypeName,
            EmployeeRate = item.EmployeeRate,
            EmployerRate = item.EmployerRate,
            CapRule = item.CapRule,
            EffectiveFrom = item.EffectiveFrom,
            EffectiveTo = item.EffectiveTo,
            LawCode = item.LawCode,
            IsActive = item.IsActive
        };
        isEditing = true;
    }

    private void CancelEdit()
    {
        isEditing = false;
        selectedItem = null;
    }

    private async Task SaveEdit()
    {
        var client = HttpFactory.CreateClient("ApiClient");
        var response = await client.PutAsJsonAsync($"api/insurancerateset/active/{editModel.RateSetId}", editModel);

        if (response.IsSuccessStatusCode)
        {
            insuranceList = await client.GetFromJsonAsync<List<InsuranceRateDTO>>("api/insurancerateset");
            activeIds = await client.GetFromJsonAsync<List<int>>("api/insurancerateset/active/ids");
            isEditing = false;
            selectedItem = null;

            successMessage = "Cập nhật thành công";
            showToast = true;
            StateHasChanged();
        }
        else
        {
            Console.WriteLine("Lưu thất bại: " + response.StatusCode);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (showToast)
        {
            await Task.Delay(3000);
            showToast = false;
            StateHasChanged();
        }
    }

    private void BackToRatesTax() => Navigation.NavigateTo("/rates-tax");
}
