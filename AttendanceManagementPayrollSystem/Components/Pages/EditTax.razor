@page "/edit-tax"
@using AttendanceManagementPayrollSystem.DTO
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Navigation
@using Blazorise

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<h3 class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
    <span>Chỉnh sửa bảng thuế</span>
    <button class="btn btn-sm btn-outline-secondary" @onclick="BackToRatesTax">
        <i class="bi bi-arrow-left"></i> Quay lại
    </button>
</h3>

@if (!string.IsNullOrEmpty(successMessage) && showToast)
{
    <div class="toast-fixed">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @successMessage
            <button type="button" class="btn-close" @onclick="() => showToast = false"></button>
        </div>
    </div>
}

<div class="row">
    <!-- Cột trái: Lịch sử thuế -->
    <div class="col-4 border-end" style="max-height:70vh; overflow-y:auto;">
        <h5>Lịch sử thuế</h5>

        @if (taxHistory == null)
        {
            <p><em>Đang tải...</em></p>
        }
        else
        {
            @foreach (var t in taxHistory)
            {
                bool isCurrentlyActive = t.IsActive;

                <div class="tax-item p-2 border-bottom @(selectedTax?.TaxId == t.TaxId ? "bg-light" : "")"
                     @onclick="() => SelectTax(t)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>@t.TaxName</strong><br />
                            <small>Từ: @t.EffectiveFrom</small><br />
                            <Badge Color="@(t.IsActive? Color.Success: Color.Secondary)" Class="mt-1">
                                @(t.IsActive ? "Đang hoạt động" : "Không hoạt động")
                            </Badge>
                        </div>

                        @if (isCurrentlyActive)
                        {
                            <button class="btn btn-sm btn-outline-primary edit-btn"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => StartEdit(t)">
                                <i class="bi bi-pencil-square"></i> Sửa
                            </button>
                        }
                    </div>
                </div>
            }

        }
    </div>

    <!-- Cột phải: Biểu mẫu chỉnh sửa -->
    <div class="col-8">
        @if (selectedTax != null)
        {
            @if (isEditing && editModel != null)
            {
                <EditForm Model="@editModel" OnValidSubmit="SaveTax">
                    <DataAnnotationsValidator />
                    <Blazorise.ValidationSummary />

                    <div class="d-flex justify-content-end mb-3">
                        <button type="submit" class="btn btn-primary me-2">Lưu</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Hủy</button>
                    </div>

                    <div class="mb-2">
                        <label>Tên thuế</label>
                        <InputText class="form-control" @bind-Value="editModel.TaxName" />
                    </div>

                    <div class="mb-2">
                        <label>Hiệu lực từ</label>
                        <InputDate class="form-control" @bind-Value="editModel.EffectiveFrom" />
                    </div>

                    <div class="mb-2">
                        <label>Hiệu lực đến</label>
                        <InputDate class="form-control" @bind-Value="editModel.EffectiveTo" />
                    </div>

                    <div class="form-check mb-2">
                        <InputCheckbox class="form-check-input" @bind-Value="editModel.IsActive" />
                        <label class="form-check-label">Đang hoạt động</label>
                    </div>

                    <h5>Bậc thuế</h5>
                    @foreach (var bracket in editModel.TaxBrackets)
                    {
                        <div class="d-flex gap-2 align-items-end mb-2">
                            <div class="flex-grow-1">
                                <label>Mức dưới</label>
                                <InputNumber class="form-control" @bind-Value="bracket.LowerBound" />
                            </div>
                            <div class="flex-grow-1">
                                <label>Mức trên</label>
                                <InputNumber class="form-control" @bind-Value="bracket.UpperBound" />
                            </div>
                            <div class="flex-grow-1">
                                <label>Thuế suất</label>
                                <InputNumber class="form-control" @bind-Value="bracket.Rate" />
                            </div>
                            <button type="button" class="btn btn-danger btn-sm mb-1" @onclick="() => RemoveBracket(bracket)">Xóa</button>
                        </div>
                    }

                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" @onclick="AddBracket">+ Thêm bậc thuế</button>
                </EditForm>
            }
            else
            {
                <div>
                    <!-- Thông tin thuế -->
                    <div class="p-3 mb-3 border border-2 border-secondary rounded-3 shadow-sm">
                        <h5>@selectedTax.TaxName</h5>
                        <p>Từ: @selectedTax.EffectiveFrom</p>
                        <p>Đến: @(selectedTax.EffectiveTo?.ToString() ?? "∞")</p>
                        <Badge Color="@(selectedTax.IsActive? Color.Success: Color.Secondary)">
                            @(selectedTax.IsActive ? "Đang hoạt động" : "Không hoạt động")
                        </Badge>
                    </div>

                    <!-- Các bậc thuế -->
                    <div class="p-3 border border-2 border-secondary rounded-3 shadow-sm">
                        <h6>Các bậc thuế</h6>
                        <table class="table table-bordered table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Mức dưới</th>
                                    <th>Mức trên</th>
                                    <th>Thuế suất</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var b in selectedTax.TaxBrackets)
                                {
                                    <tr>
                                        <td>@b.LowerBound</td>
                                        <td>@(b.UpperBound?.ToString() ?? "Không giới hạn")</td>
                                        <td>@(b.Rate * 100)%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>


            }
        }
        else
        {
            <p>Chọn một bảng thuế ở bên trái để xem chi tiết.</p>
        }
    </div>
</div>

@code {
    private List<TaxDTO>? taxHistory;
    private TaxDTO? selectedTax;
    private TaxEditDTO? editModel;
    private bool isEditing = false;
    private string? successMessage;
    private bool showToast = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTaxHistory();
    }

    private async Task LoadTaxHistory()
    {
        var client = HttpFactory.CreateClient("ApiClient");
        taxHistory = await client.GetFromJsonAsync<List<TaxDTO>>("api/tax");

        selectedTax = taxHistory?.FirstOrDefault(t => t.IsActive);
        isEditing = false;
    }

    private void SelectTax(TaxDTO tax)
    {
        selectedTax = tax;
        isEditing = false;
    }

    private void StartEdit(TaxDTO tax)
    {
        selectedTax = tax;
        isEditing = true;

        editModel = new TaxEditDTO
        {
            TaxId = tax.TaxId,
            TaxName = tax.TaxName,
            EffectiveFrom = tax.EffectiveFrom,
            EffectiveTo = tax.EffectiveTo,
            IsActive = tax.IsActive,
            TaxBrackets = tax.TaxBrackets.Select(b => new TaxBracketEditDTO
            {
                BracketId = b.BracketId,
                LowerBound = b.LowerBound,
                UpperBound = b.UpperBound,
                Rate = b.Rate
            }).ToList()
        };
    }

    private void CancelEdit()
    {
        isEditing = false;
        editModel = null;
    }

    private void AddBracket()
    {
        editModel?.TaxBrackets.Add(new TaxBracketEditDTO());
    }

    private void RemoveBracket(TaxBracketEditDTO bracket)
    {
        editModel?.TaxBrackets.Remove(bracket);
    }

    private async Task SaveTax()
    {
        if (editModel == null) return;

        var client = HttpFactory.CreateClient("ApiClient");

        // POST tạo bảng thuế mới và vô hiệu hóa bảng cũ
        var response = await client.PostAsJsonAsync("api/tax/edit", editModel);
        if (response.IsSuccessStatusCode)
        {
            await LoadTaxHistory();
            isEditing = false;
            editModel = null;

            successMessage = "Chỉnh sửa thành công";
            showToast = true;
            StateHasChanged();
        }
        else
        {
            var msg = await response.Content.ReadAsStringAsync();
            Console.WriteLine(msg);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (showToast)
        {
            await Task.Delay(3000);
            showToast = false;
            StateHasChanged();
        }
    }

    private void BackToRatesTax()
    {
        Navigation.NavigateTo("/rates-tax");
    }
}
