@using AttendanceManagementPayrollSystem.DTO
@inject IHttpClientFactory HttpFactory

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

@if (isOpen)
{
    <div class="modal fade show d-block custom-modal-overlay" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content custom-modal-content">
                <div class="modal-header custom-modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus-fill me-2"></i>Thêm người phụ thuộc
                    </h5>
                    <button type="button" class="btn-close custom-btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body custom-modal-body">
                    <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <div class="row g-3">
                            <!-- Họ tên -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">Họ tên <span class="text-danger">*</span></label>
                                <InputText class="form-control custom-form-control" @bind-Value="model.FullName" placeholder="Nhập họ tên" />
                                <ValidationMessage For="@(() => model.FullName)" class="text-danger small" />
                            </div>

                            <!-- Quan hệ -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">Quan hệ <span class="text-danger">*</span></label>
                                <InputSelect class="form-select custom-form-select" @bind-Value="model.Relationship">
                                    <option value="">-- Chọn quan hệ --</option>
                                    <option value="Vợ">Vợ</option>
                                    <option value="Chồng">Chồng</option>
                                    <option value="Con trai">Con trai</option>
                                    <option value="Con gái">Con gái</option>
                                    <option value="Cha">Cha</option>
                                    <option value="Mẹ">Mẹ</option>
                                    <option value="Anh">Anh</option>
                                    <option value="Chị">Chị</option>
                                    <option value="Em">Em</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => model.Relationship)" class="text-danger small" />
                            </div>

                            <!-- Ngày sinh -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">Ngày sinh</label>
                                <InputDate class="form-control custom-form-control" @bind-Value="dateOfBirth" />
                            </div>

                            <!-- Giới tính -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">Giới tính <span class="text-danger">*</span></label>
                                <InputSelect class="form-select custom-form-select" @bind-Value="model.Gender">
                                    <option value="">-- Chọn giới tính --</option>
                                    <option value="M">Nam</option>
                                    <option value="F">Nữ</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => model.Gender)" class="text-danger small" />
                            </div>

                            <!-- CMND/CCCD -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">CMND/CCCD <span class="text-danger">*</span></label>
                                <InputText class="form-control custom-form-control" @bind-Value="model.NationalId" placeholder="Nhập số CMND/CCCD" />
                                <ValidationMessage For="@(() => model.NationalId)" class="text-danger small" />
                            </div>

                            <!-- Giảm trừ thuế -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">Giảm trừ thuế</label>
                                <div class="form-check form-switch mt-2">
                                    <InputCheckbox class="form-check-input custom-form-check-input" @bind-Value="model.IsTaxDependent" id="isTaxDependent" />
                                    <label class="form-check-label custom-form-check-label" for="isTaxDependent">
                                        Được giảm trừ thuế
                                    </label>
                                </div>
                            </div>

                            <!-- Ngày hiệu lực -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">Ngày hiệu lực <span class="text-danger">*</span></label>
                                <InputDate class="form-control custom-form-control" @bind-Value="effectiveStartDate" />
                            </div>

                            <!-- Ngày hết hạn -->
                            <div class="col-md-6">
                                <label class="form-label custom-form-label">Ngày hết hạn</label>
                                <InputDate class="form-control custom-form-control" @bind-Value="effectiveEndDate" />
                                <small class="text-muted">Để trống nếu không giới hạn</small>
                            </div>

                            <!-- Minh chứng -->
                            <div class="col-12">
                                <label class="form-label custom-form-label">URL Minh chứng</label>
                                <InputText class="form-control custom-form-control" @bind-Value="model.Proof" placeholder="Nhập URL hoặc để trống" />
                                <small class="text-muted">Link đến tài liệu minh chứng (nếu có)</small>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert custom-alert-danger mt-3 mb-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert custom-alert-success mt-3 mb-0">
                                <i class="bi bi-check-circle-fill me-2"></i>@successMessage
                            </div>
                        }

                        <div class="modal-footer mt-4 border-top pt-3 custom-modal-footer">
                            <button type="button" class="btn custom-btn-secondary" @onclick="Close" disabled="@isSubmitting">
                                <i class="bi bi-x-circle me-2"></i>Hủy
                            </button>
                            <button type="submit" class="btn custom-btn-accent" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2 custom-spinner-accent"></span>
                                    <span>Đang xử lý...</span>
                                }
                                else
                                {
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span>Lưu</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Custom modal overlay */
    .custom-modal-overlay {
        background-color: rgba(0, 0, 0, 0.5) !important;
    }

    /* Custom modal content */
    .custom-modal-content {
        border: 2px solid #97322D;
        background-color: #FFE4A1;
    }

    /* Custom modal header */
    .custom-modal-header {
        background-color: #97322D !important;
        color: white !important;
        border-bottom: 2px solid #FFE4A1;
    }

    /* Custom close button */
    .custom-btn-close {
        filter: invert(1);
    }

    /* Custom modal body */
    .custom-modal-body {
        background-color: rgba(255, 255, 255, 0.95);
    }

    /* Custom form labels */
    .custom-form-label {
        color: #97322D !important;
        font-weight: bold;
    }

    /* Custom form controls */
    .custom-form-control {
        border: 1px solid #97322D;
    }

    /* Custom form select */
    .custom-form-select {
        border: 1px solid #97322D;
    }

    /* Custom form check input */
    .custom-form-check-input {
        accent-color: #97322D;
    }

    /* Custom form check label */
    .custom-form-check-label {
        color: #97322D;
    }

    /* Custom alerts */
    .custom-alert-danger {
        background-color: rgba(220, 53, 69, 0.1) !important;
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }

    .custom-alert-success {
        background-color: rgba(25, 135, 84, 0.1) !important;
        border-color: #198754 !important;
        color: #198754 !important;
    }

    /* Custom modal footer */
    .custom-modal-footer {
        border-top: 2px solid #97322D !important;
        background-color: rgba(255, 228, 161, 0.8);
    }

    /* Custom secondary button */
    .custom-btn-secondary {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: white !important;
    }

    /* Custom accent button (Save) */
    .custom-btn-accent {
        background-color: #97322D !important;
        border-color: #97322D !important;
        color: white !important;
    }

    /* Custom spinner */
    .custom-spinner-accent {
        color: #97322D !important;
    }
</style>

@code {
    [Parameter] public int EmployeeId { get; set; }
    [Parameter] public EventCallback OnDependentAdded { get; set; }

    private bool isOpen = false;
    private bool isSubmitting = false;
    private string? errorMessage;
    private string? successMessage;

    private EmployeeDependentCreateDTO model = new();
    private DateTime? dateOfBirth;
    private DateTime effectiveStartDate = DateTime.Today;
    private DateTime? effectiveEndDate;

    public void Open()
    {
        // Reset form
        model = new EmployeeDependentCreateDTO
        {
            EmployeeId = EmployeeId,
            IsTaxDependent = false
        };
        dateOfBirth = null;
        effectiveStartDate = DateTime.Today;
        effectiveEndDate = null;
        errorMessage = null;
        successMessage = null;
        isSubmitting = false;

        isOpen = true;
        StateHasChanged();
    }

    public void Close()
    {
        isOpen = false;
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;
            successMessage = null;

            // Convert DateTime to DateOnly
            model.DateOfBirth = dateOfBirth.HasValue ? DateOnly.FromDateTime(dateOfBirth.Value) : null;
            model.EffectiveStartDate = DateOnly.FromDateTime(effectiveStartDate);
            model.EffectiveEndDate = effectiveEndDate.HasValue ? DateOnly.FromDateTime(effectiveEndDate.Value) : null;
            model.EmployeeId = EmployeeId;

            var client = HttpFactory.CreateClient("ApiClient");
            var response = await client.PostAsJsonAsync("api/employeedependent", model);

            if (response.IsSuccessStatusCode)
            {
                successMessage = "Thêm người phụ thuộc thành công!";
                await Task.Delay(1000);
                await OnDependentAdded.InvokeAsync();
                Close();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Lỗi: {response.StatusCode} - {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Có lỗi xảy ra: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}