@using AttendanceManagementPayrollSystem.DTO
@inject IHttpClientFactory HttpFactory
@using Microsoft.AspNetCore.Components.Forms

@if (IsVisible)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-container" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h4>
                    <i class="bi bi-person-plus-fill"></i>
                    Thêm nhân viên mới
                </h4>
                <button class="btn-close-modal" @onclick="CloseModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                @if (IsLoadingDepartments)
                {
                    <div class="text-center py-4">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p class="mt-3 text-muted">Đang tải danh sách phòng ban...</p>
                    </div>
                }
                else
                {
                    <EditForm Model="@NewEmployee" OnValidSubmit="@HandleSubmit">
                        <DataAnnotationsValidator />

                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-person"></i>
                                Tên nhân viên
                            </label>
                            <InputText @bind-Value="NewEmployee.EmpName" class="form-control" placeholder="Nhập tên nhân viên" />
                            <ValidationMessage For="@(() => NewEmployee.EmpName)" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-person-circle"></i>
                                    Tên đăng nhập
                                </label>
                                <InputText @bind-Value="NewEmployee.Username" class="form-control" placeholder="username" />
                                <ValidationMessage For="@(() => NewEmployee.Username)" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-shield-lock"></i>
                                    Mật khẩu
                                </label>
                                <InputText @bind-Value="NewEmployee.Password" type="password" class="form-control" placeholder="Mật khẩu" />
                                <ValidationMessage For="@(() => NewEmployee.Password)" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-telephone"></i>
                                    Số điện thoại
                                </label>
                                <InputText @bind-Value="NewEmployee.EmpPhoneNumber" class="form-control" placeholder="0123456789" />
                                <ValidationMessage For="@(() => NewEmployee.EmpPhoneNumber)" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-calendar-event"></i>
                                    Ngày sinh
                                </label>
                                <InputDate @bind-Value="NewEmployee.EmpDob" class="form-control" />
                                <ValidationMessage For="@(() => NewEmployee.EmpDob)" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-building"></i>
                                Phòng ban
                            </label>
                            <InputSelect @bind-Value="NewEmployee.DepId" class="form-select">
                                <option value="">-- Chọn phòng ban --</option>
                                @foreach (var dep in DepartmentList)
                                {
                                    <option value="@dep.DepId">@dep.DepName</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => NewEmployee.DepId)" />
                        </div>

                        <button type="submit" class="btn-submit" disabled="@IsSubmitting">
                            @if (IsSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                                <span>Đang xử lý...</span>
                            }
                            else
                            {
                                <i class="bi bi-check-circle-fill"></i>
                                <span>Tạo tài khoản</span>
                            }
                        </button>
                    </EditForm>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter] public List<DepartmentDTO> DepartmentList { get; set; } = new();
    [Parameter] public bool IsLoadingDepartments { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private EmployeeCreateDTO NewEmployee { get; set; } = new();
    private bool IsSubmitting { get; set; }

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        try
        {
            var client = HttpFactory.CreateClient("ApiClient");
            var response = await client.PostAsJsonAsync("/api/employee", NewEmployee);
            if (response.IsSuccessStatusCode)
            {
                await OnSaved.InvokeAsync();
                await CloseModal();
            }
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}
