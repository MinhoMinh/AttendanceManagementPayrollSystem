@page "/dashboard"

@using AttendanceManagementPayrollSystem.UI.Components
@using AttendanceManagementPayrollSystem.DTO
@using System.Text.Json
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Bảng điều khiển</PageTitle>

<Layout>
    <LayoutHeader Style="background: linear-gradient(135deg, #97322D 0%, #7A2824 100%); box-shadow: 0 4px 12px rgba(151, 50, 45, 0.3); padding: 20px 0;">
        <div class="d-flex align-items-center justify-content-between px-4">
            <h3 class="m-0" style="color: #FFE4A1; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                <i class="fas fa-tachometer-alt me-3"></i>Bảng điều khiển
            </h3>
            @if (Employee != null)
            {
                <div style="color: #FFE4A1; font-weight: 500;">
                    <i class="fas fa-user-circle me-2"></i>Xin chào, <strong>@Employee.EmpName</strong>
                </div>
            }
        </div>
    </LayoutHeader>

    <LayoutContent Style="background: linear-gradient(180deg, #FFF9ED 0%, #FFFEF9 100%); min-height: calc(100vh - 120px);">
        <div class="m-4">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border" style="color: #97322D;" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            }
            else
            {
                <DashboardButtonGroup Buttons="@EmployeeService" GroupName="Dịch vụ nhân viên" Icon="fas fa-user-tie" />
                <DashboardButtonGroup Buttons="@DepartmentHeadService" GroupName="Dịch vụ trưởng phòng" Icon="fas fa-users-cog" />
                <DashboardButtonGroup Buttons="@CompanyService" GroupName="Dịch vụ công ty" Icon="fas fa-building" />
            }
        </div>
    </LayoutContent>
</Layout>

<Toaster />

<style>
    /* Card styling */
    .card {
        border: 2px solid #FFE4A1;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(151, 50, 45, 0.1);
        transition: all 0.3s ease;
        background: white;
    }

        .card:hover {
            box-shadow: 0 8px 20px rgba(151, 50, 45, 0.2);
            transform: translateY(-2px);
        }

    /* Header animation */
    @@keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .layout-header {
        animation: fadeInDown 0.5s ease;
    }
</style>

@code {
    bool toastVisible = false;
    private bool isLoading = false;

    private EmployeeDTO? Employee;

    private List<DashboardButton> EmployeeService = new();
    private List<DashboardButton> DepartmentHeadService = new();
    private List<DashboardButton> CompanyService = new();

    [Inject] INotificationService NotificationService { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            var empJson = await JS.InvokeAsync<string>("localStorage.getItem", "employee");
            if (!string.IsNullOrWhiteSpace(empJson))
            {
                Employee = JsonSerializer.Deserialize<EmployeeDTO>(empJson);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Warning("Không thể tìm thấy thông tin nhân viên!", "Lỗi");
        }

        BuildButtonGroups();
        isLoading = false;
        StateHasChanged();
    }

    private void BuildButtonGroups()
    {
        if (Employee == null) return;

        EmployeeService = new()
        {
            new() { Text = "Lịch tổng hợp", ImageSrc="https://cdn-icons-png.flaticon.com/512/3062/3062634.png", OnClick = EventCallback.Factory.Create(this, NavigateAttendance), Visible = HasPermission("has_clockin") },
            new() { Text = "Lịch làm việc", ImageSrc="https://cdn-icons-png.flaticon.com/512/1077/1077976.png", OnClick = EventCallback.Factory.Create(this, NavigateSelfShift), Visible = HasPermission("has_shift") },
            new() { Text = "Bảng lương cá nhân", ImageSrc = "https://cdn-icons-png.flaticon.com/512/3135/3135695.png", OnClick = EventCallback.Factory.Create(this, NavigateSelfPayItem), Visible = HasPermission("view_employee_payroll") },
            new() { Text = "Nghi phép", ImageSrc="https://cdn-icons-png.flaticon.com/512/1077/1077976.png", OnClick = EventCallback.Factory.Create(this, NavigateSelfLeave), Visible = HasPermission("has_leave_request") },
            new() { Text = "Giờ vượt", ImageSrc="https://cdn-icons-png.flaticon.com/512/1077/1077976.png", OnClick = EventCallback.Factory.Create(this, NavigateSelfOvertime), Visible = HasPermission("has_overtime_request") },
        };

        DepartmentHeadService = new()
        {
            new() { Text = "Chấm công phòng ban", ImageSrc="https://cdn-icons-png.flaticon.com/512/1077/1077976.png", OnClick = EventCallback.Factory.Create(this, NavigateAllClockin), Visible = HasPermission("view_employee_clockin") },
            new() { Text = "Giờ vượt phòng ban", ImageSrc="https://cdn-icons-png.flaticon.com/512/1077/1077976.png", OnClick = EventCallback.Factory.Create(this, NavigateHeadOvertime), Visible = HasPermission("overtime_request_management") },
            new() { Text = "Nghỉ phép phòng ban", ImageSrc="https://cdn-icons-png.flaticon.com/512/1077/1077976.png", OnClick = EventCallback.Factory.Create(this, NavigateLeaveRequestManagement), Visible = HasPermission("leave_request_management") },
        };

        CompanyService = new()
        {
            new() { Text = "Thông tin nhân viên", ImageSrc = "https://cdn-icons-png.flaticon.com/512/1828/1828926.png", OnClick = EventCallback.Factory.Create(this, NavigateCompanyEmployee), Visible = HasPermission("view_company_employee") },
            new() { Text = "Cập nhật chấm công", ImageSrc = "https://cdn-icons-png.flaticon.com/512/1828/1828926.png", OnClick = EventCallback.Factory.Create(this, NavigateUploadClockins), Visible = HasPermission("upload_clockin") },
            new() { Text = "Bảng lương công ty", ImageSrc = "https://cdn-icons-png.flaticon.com/512/3135/3135695.png", OnClick = EventCallback.Factory.Create(this, NavigatePayRun), Visible = HasPermission("view_payroll_run") },
            new() { Text = "Thiết lập ngày lễ", ImageSrc = "https://cdn-icons-png.flaticon.com/512/616/616408.png", OnClick = EventCallback.Factory.Create(this, NavigateHolidaySetup), Visible = HasPermission("edit_holiday_calendar") },
            new() { Text = "Chính sách lương", ImageSrc = "https://cdn-icons-png.flaticon.com/512/709/709496.png", OnClick = EventCallback.Factory.Create(this, NavigateSalaryPolicy), Visible = HasPermission("edit_salary_policy") },
            new() { Text = "Chính sách bảo hiểm/thuế", ImageSrc = "https://cdn-icons-png.flaticon.com/512/942/942799.png", OnClick = EventCallback.Factory.Create(this, NavigateInsuranceTaxPolicy), Visible = HasPermission("edit_tax_insurance") },
            new() { Text = "Quản lý ca làm việc", ImageSrc = "https://cdn-icons-png.flaticon.com/512/1828/1828926.png", OnClick = EventCallback.Factory.Create(this, NavigateShiftManagement), Visible = HasPermission("shift_management") },
            new() { Text = "Quản lý tài khoản nhân viên", ImageSrc = "https://cdn-icons-png.flaticon.com/512/1828/1828926.png", OnClick = EventCallback.Factory.Create(this, NavigateAccountManagement), Visible = HasPermission("employee_account_management") },
            new() { Text = "Khai báo người phụ thuộc", ImageSrc = "https://cdn-icons-png.flaticon.com/512/1828/1828926.png", OnClick = EventCallback.Factory.Create(this, NavigateDependentManagement), Visible = HasPermission("declare_dependent") },
            new() { Text = "Quản lý thưởng", ImageSrc = "https://cdn-icons-png.flaticon.com/512/1828/1828926.png", OnClick = EventCallback.Factory.Create(this, NavigateBonus), Visible = HasPermission("manage_bonus") },
        };

    }

    private bool HasPermission(string task)
    {
        if (Employee?.Permissions == null) return false;
        return Employee.Permissions.Contains(task);
    }

    private void NavigateDependentManagement() => Navigation.NavigateTo("/dependent-management");
    private void NavigateAccountManagement() => Navigation.NavigateTo("/employees/group");
    private void NavigateAttendance() => Navigation.NavigateTo("/attendance/self");
    private void NavigateSelfKpi() => Navigation.NavigateTo("/kpi/self");
    private void NavigateSelfShift() => Navigation.NavigateTo("/shift/self");
    private void NavigateSelfOvertime() => Navigation.NavigateTo("/overtime/self");
    private void NavigateSelfLeave() => Navigation.NavigateTo("/leave/self");
    private void NavigateBonus() => Navigation.NavigateTo("/bonus-manager");
    // private void NavigateSelfPayItem()
    // {
    //     if (Employee == null) return;
    //     int empId = Employee.EmpId;
    //     int month = DateTime.Now.AddYears(-1).Month;
    //     int year = DateTime.Now.AddYears(-1).Year;

    //     Navigation.NavigateTo($"/payrun/{empId}/{month}/{year}");
    // }

    private void NavigateSelfPayItem()
    {
        Navigation.NavigateTo($"/payrun/self");
    }

    private void NavigateDepKpi() => Navigation.NavigateTo("/kpi/head");
    private void NavigateHeadOvertime() => Navigation.NavigateTo("/overtime/head");
    private void NavigateLeaveRequestManagement() => Navigation.NavigateTo("/approve-leave-requests");


    //employees/group/view
    private void NavigateCompanyEmployee() => Navigation.NavigateTo("/employees/group/view");
    private void NavigateUploadClockins() => Navigation.NavigateTo("/xlsupload");
    private void NavigatePayRun() => Navigation.NavigateTo("/payruns");
    private void NavigateHolidaySetup() => Navigation.NavigateTo("/department-holiday");
    private void NavigateSalaryPolicy() => Navigation.NavigateTo("/salary-policies");
    private void NavigateInsuranceTaxPolicy() => Navigation.NavigateTo("/rates-tax");
    private void NavigateShiftManagement() => Navigation.NavigateTo("/shift-management");

    private void NavigateAllClockin() => Navigation.NavigateTo("/allclockin");
    
}
