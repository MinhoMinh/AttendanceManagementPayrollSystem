@page "/leave/self"
@using System.Net.Http.Json
@using AttendanceManagementPayrollSystem.DTO
@using System.Text.Json
@using AttendanceManagementPayrollSystem.DTOs
@using AttendanceManagementPayrollSystem.Models
@inject IJSRuntime JS
@inject IHttpClientFactory HttpFactory

<div class="d-flex" style="width:100%; gap:1rem;">

    <!-- Trái -->
    <div style="flex:1; display:flex; flex-direction:column; gap:1rem;">

        <Card>
            <CardBody>
                <div class="d-flex justify-content-between align-items-start" style="gap:0.5rem;">

                    <div class="d-flex" style="gap:0.5rem;">
                        <div>
                            <label>Tu ngay</label>
                            <Blazorise.DatePicker TValue="DateTime?" Date="fromDate" DateChanged="LoadData" />
                        </div>

                        <div>
                            <label>Den ngay</label>
                            <Blazorise.DatePicker TValue="DateTime?" Date="toDate" DateChanged="LoadData" />
                        </div>
                    </div>

                    <Button Color="Color.Primary" @onclick="ShowAddModal">Thêm mới</Button>

                </div>
            </CardBody>
        </Card>


        <Card>
            <CardBody>
                @if (requests == null)
                {
                    <p>Đang tải...</p>
                }
                else
                {
                    <Table Hoverable="true">
                        <TableHeader>
                            <TableRow>
                                <TableHeaderCell>Ngày</TableHeaderCell>
                                <TableHeaderCell>Giờ</TableHeaderCell>
                                <TableHeaderCell>Trạng thái</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var item in requests)
                            {
                                <TableRow @onclick="() => Select(item)">
                                    <TableRowCell>@item.StartDate</TableRowCell>
                                    <TableRowCell>@item.NumbersOfDays</TableRowCell>
                                    <TableRowCell>@item.Status</TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                }
            </CardBody>
        </Card>

    </div>

    <!-- Phải -->
    <div style="flex:1;">
        @if (selected != null)
        {
            <Card Class="p-3">
                <CardBody>
                    <h6 class="fw-bold mb-3">Chi tiết đơn nghỉ phép</h6>

                    <div class="mb-2"><strong>Mã yêu cầu:</strong> @selected.ReqId</div>
                    <div class="mb-2"><strong>Nhân viên ID:</strong> @selected.EmpId</div>
                    <div class="mb-2"><strong>Bắt đầu:</strong> @selected.StartDate.ToShortDateString()</div>
                    <div class="mb-2"><strong>Kết thúc:</strong> @selected.EndDate.ToShortDateString()</div>
                    <div class="mb-2"><strong>Số ngày nghỉ:</strong> @selected.NumbersOfDays</div>
                    <div class="mb-2"><strong>Loại nghỉ:</strong> @selected.TypeId</div>
                    <div class="mb-2"><strong>Trạng thái:</strong> @selected.Status</div>
                    <div class="mb-2"><strong>Lý do:</strong> @selected.Reason</div>
                </CardBody>
            </Card>

        }
    </div>


</div>

<Modal @bind-Visible="addVisible"
       Class="overtime-modal"
       Backdrop="Backdrop.Static">

    <ModalHeader>Thêm yêu cầu nghi phep</ModalHeader>

    <ModalBody class="p-3" style="background:#f5f5f5;">


        <div class="mb-2 d-flex" style="gap:0.5rem;">
            <div style="flex:1;">
                <label>Bắt đầu</label>
                <Blazorise.DatePicker TValue="DateOnly?" @bind-Date="newStart"/>
            </div>

            <div style="flex:1;">
                <label>Kết thúc</label>
                <Blazorise.DatePicker TValue="DateOnly?" @bind-Date="newEnd" />
            </div>
        </div>

        <div class="mb-2">
            <label>Tổng ngay</label>
            <p>@daysDisplay</p>
        </div>

        <div class="mb-2">
            <label>Loại nghi phep</label>
            <Select TValue="int?" @bind-SelectedValue="selectedTypeId">
                <SelectItem Value="@( (int?)null )">-- chọn --</SelectItem>
                @foreach (var t in types)
                {
                    <SelectItem Value="t.Id">@t.Name</SelectItem>
                }
            </Select>
        </div>

        <div class="mb-2">
            <label>Lý do</label>
            <TextEdit @bind-Text="newReason" />
        </div>
    </ModalBody>

    <ModalFooter>
        <Button Color="Color.Primary" @onclick="Submit">Lưu</Button>
        <Button Color="Color.Secondary" @onclick="HideAddModal">Hủy</Button>
    </ModalFooter>

</Modal>

<style>
    .overtime-modal {
        max-width: 50vw;
        margin: auto;
    }
</style>


@code {
    EmployeeDTO Employee;
    DateTime fromDate = DateTime.Today.AddYears(-1);
    DateTime toDate = DateTime.Today;

    WeeklyShiftDto shift;
    EmployeeBalanceDto balance;

    List<LeaveRequestDTO> requests;
    List<LeaveType> types = new();
    LeaveRequestDTO selected;
    int? selectedTypeId;

    bool addVisible;
    //DateTime newReqDate;

    string newReason;
    DateOnly? _newStart;
    DateOnly? newStart
    {
        get => _newStart;
        set
        {
            _newStart = value;
            Recalc();
        }
    }
    DateOnly? _newEnd;
    DateOnly? newEnd
    {
        get => _newEnd;
        set
        {
            _newEnd = value;
            Recalc();
        }
    }

    void Recalc()
    {
        if (newStart.HasValue && newEnd.HasValue)
        {
            var start = newStart.Value;
            var end = newEnd.Value;

            if (end < start)
            {
                days = null;
                return;
            }

            days = (decimal)(end.DayNumber - start.DayNumber + 1);
        }
        else
        {
            days = null;
        }
    }


    [Inject] INotificationService NotificationService { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var empJson = await JS.InvokeAsync<string>("localStorage.getItem", "employee");
            if (!string.IsNullOrWhiteSpace(empJson))
            {
                Employee = JsonSerializer.Deserialize<EmployeeDTO>(empJson);
                LoadData(null);
            }

            var client = HttpFactory.CreateClient("ApiClient");
            var response = await client.GetFromJsonAsync<IEnumerable<LeaveType>>(
                $"api/leave/rates");
            if (response == null)
            {
                NotificationService.Warning("Không tìm thấy dữ liệu loai tăng ca", "Lỗi");
            }
            else
            {
                types = response.ToList();
            }

        }
        catch
        {
            NotificationService.Warning("Không tìm thấy thông tin nhân viên", "Lỗi");
        }
    }

    async Task LoadData(DateTime? _)
    {
        if (Employee == null)
        {
            NotificationService.Warning("Không tìm thấy thông tin nhân viên", "Lỗi");
            return;
        }

        var client = HttpFactory.CreateClient("ApiClient");
        var response = await client.GetFromJsonAsync<List<LeaveRequestDTO>>(
            $"api/leave/history?empId={Employee.EmpId}&startDate={fromDate}&endDate={toDate}");

        if (response == null)
        {
            NotificationService.Warning("Không tìm thấy dữ liệu nghi phep", "Lỗi");
            return;
        }

        requests = response;
        StateHasChanged();
    }

    void Select(LeaveRequestDTO item) => selected = item;

    void ShowAddModal()
    {
        //newReqDate = DateOnly.FromDateTime(DateTime.Today);
        addVisible = true;
    }
    void HideAddModal() => addVisible = false;

    async Task Submit()
    {
        if (days == null)
        {
            NotificationService.Warning("Không thể tìm thấy giờ.", "Lỗi");
            return;
        }

        if (selectedTypeId == null)
    {
            NotificationService.Warning("Chua chon loai ngay nghi.", "Lỗi");
            return;
        }

        if (Employee == null)
        {
            NotificationService.Warning("Không thể tìm thấy thong tin nhan vien.", "Lỗi");
            return;
        }

        var request = new LeaveRequestDTO
            {
                EmpId = Employee.EmpId,
                TypeId = (int)selectedTypeId,
                ReqDate = newStart.Value,
                StartDate = newStart.Value,
                EndDate = newEnd.Value,
                NumbersOfDays = days.Value,
                Reason = newReason,
                Status = "Pending"
            };

        var client = HttpFactory.CreateClient("ApiClient");
        var res = await client.PostAsJsonAsync("api/leave/request", request);

        if (!res.IsSuccessStatusCode)
        {
            NotificationService.Warning("Gửi thất bại.", "Lỗi");
            return;
        }

        NotificationService.Success("Đã gửi");
        addVisible = false;
        await LoadData(null);
    }


    decimal? days;
    string daysDisplay => days?.ToString("0.##") ?? "0";

}
