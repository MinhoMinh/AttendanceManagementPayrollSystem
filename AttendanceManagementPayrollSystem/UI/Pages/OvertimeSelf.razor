@page "/overtime/self"
@using System.Net.Http.Json
@using AttendanceManagementPayrollSystem.DTO
@using System.Text.Json
@using AttendanceManagementPayrollSystem.Models
@inject IJSRuntime JS
@inject IHttpClientFactory HttpFactory

<div class="d-flex" style="width:100%; gap:1rem;">

    <!-- Trái -->
    <div style="flex:1; display:flex; flex-direction:column; gap:1rem;">

        <Card>
            <CardBody>
                <div class="d-flex justify-content-between align-items-start" style="gap:0.5rem;">

                    <div class="d-flex" style="gap:0.5rem;">
                        <div>
                            <label>Tu ngay</label>
                            <Blazorise.DatePicker TValue="DateOnly?" Date="fromDate" DateChanged="LoadData" />
                        </div>

                        <div>
                            <label>Den ngay</label>
                            <Blazorise.DatePicker TValue="DateOnly?" Date="toDate" DateChanged="LoadData" />
                        </div>
                    </div>

                    <Button Color="Color.Primary" @onclick="ShowAddModal">Thêm mới</Button>

                </div>
            </CardBody>
        </Card>


        <Card>
            <CardBody>
                @if (requests == null)
                {
                    <p>Đang tải...</p>
                }
                else
                {
                    <Table Hoverable="true">
                        <TableHeader>
                            <TableRow>
                                <TableHeaderCell>Ngày</TableHeaderCell>
                                <TableHeaderCell>Giờ</TableHeaderCell>
                                <TableHeaderCell>Trạng thái</TableHeaderCell>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            @foreach (var item in requests)
                            {
                                <TableRow @onclick="() => Select(item)">
                                    <TableRowCell>@item.ReqDate</TableRowCell>
                                    <TableRowCell>@item.Hours</TableRowCell>
                                    <TableRowCell>@item.Status</TableRowCell>
                                </TableRow>
                            }
                        </TableBody>
                    </Table>
                }
            </CardBody>
        </Card>

    </div>

    <!-- Phải -->
    <div style="flex:1;">
        @if (selected != null)
        {
            <Card Class="p-3">
                <CardBody>
                    <h6 class="fw-bold mb-3">Chi tiết yêu cầu</h6>

                    <div class="mb-2"><strong>Ngày:</strong> @selected.ReqDate</div>
                    <div class="mb-2"><strong>Bắt đầu:</strong> @selected.StartTime</div>
                    <div class="mb-2"><strong>Kết thúc:</strong> @selected.EndTime</div>
                    <div class="mb-2"><strong>Giờ:</strong> @selected.Hours</div>
                    <div class="mb-2"><strong>Loại:</strong> @selected.OvertimeTypeName</div>
                    <div class="mb-2"><strong>Trạng thái:</strong> @selected.Status</div>
                    <div class="mb-2"><strong>Lý do:</strong> @selected.Reason</div>
                    <div class="mb-2"><strong>Duyệt bởi:</strong> @selected.ApprovedByName</div>
                    <div class="mb-2"><strong>Ngày duyệt:</strong> @selected.ApprovedDate</div>
                </CardBody>
            </Card>
        }
    </div>


</div>

<Modal @bind-Visible="addVisible"
       Class="overtime-modal"
       Backdrop="Backdrop.Static">

    <ModalHeader>Thêm yêu cầu tăng ca</ModalHeader>

    <ModalBody class="p-3" style="background:#f5f5f5;">
        <div class="mb-2">
            <label>Ngày</label>
            <Blazorise.DatePicker @bind-Date="newReqDate" />
        </div>

        <div class="mb-2 d-flex" style="gap:0.5rem;">
            <div style="flex:1;">
                <label>Bắt đầu</label>
                <TimePicker TValue="TimeOnly?" @bind-Time="newStart"/>
            </div>

            <div style="flex:1;">
                <label>Kết thúc</label>
                <TimePicker TValue="TimeOnly?" @bind-Time="newEnd" />
            </div>
        </div>

        <div class="mb-2">
            <label>Tổng giờ</label>
            <p>@hoursDisplay</p>
        </div>

        <div class="mb-2">
            <label>Loại tăng ca</label>
            <Select TValue="int?" @bind-SelectedValue="selectedTypeId">
                <SelectItem Value="@( (int?)null )">-- chọn --</SelectItem>
                @foreach (var t in types)
                {
                    <SelectItem Value="t.Id">@t.OvertimeType</SelectItem>
                }
            </Select>
        </div>

        <div class="mb-2">
            <label>Lý do</label>
            <TextEdit @bind-Text="newReason" />
        </div>
    </ModalBody>

    <ModalFooter>
        <Button Color="Color.Primary" @onclick="Submit">Lưu</Button>
        <Button Color="Color.Secondary" @onclick="HideAddModal">Hủy</Button>
    </ModalFooter>

</Modal>

<style>
    .overtime-modal {
        max-width: 50vw;
        margin: auto;
    }
</style>


@code {
    EmployeeDTO Employee;
    DateOnly fromDate = DateOnly.FromDateTime(DateTime.Today.AddYears(-1));
    DateOnly toDate = DateOnly.FromDateTime(DateTime.Today);

    List<OvertimeRequestDTO> requests;
    List<OvertimeRateDTO> types = new();
    OvertimeRequestDTO selected;
    int? selectedTypeId;

    bool addVisible;
    DateOnly newReqDate;
    string newReason;
    TimeOnly? _newStart;
    TimeOnly? newStart
    {
        get => _newStart;
        set
        {
            _newStart = value;
            Recalc();
        }
    }
    TimeOnly? _newEnd;
    TimeOnly? newEnd
    {
        get => _newEnd;
        set
        {
            _newEnd = value;
            Recalc();
        }
    }

    void Recalc()
    {
        if (newStart.HasValue && newEnd.HasValue)
        {
            hours = (decimal)(newEnd.Value - newStart.Value).TotalHours;
            if (hours < 0) hours = null;
        }
        else hours = null;

    }


    [Inject] INotificationService NotificationService { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var empJson = await JS.InvokeAsync<string>("localStorage.getItem", "employee");
            if (!string.IsNullOrWhiteSpace(empJson))
            {
                Employee = JsonSerializer.Deserialize<EmployeeDTO>(empJson);
                LoadData(null);
            }

            var client = HttpFactory.CreateClient("ApiClient");
            var response = await client.GetFromJsonAsync<IEnumerable<OvertimeRateDTO>>(
                $"api/overtime/rates");
            if (response == null)
            {
                NotificationService.Warning("Không tìm thấy dữ liệu loai tăng ca", "Lỗi");
            }
            else
            {
                types = response.ToList();
            }

        }
        catch
        {
            NotificationService.Warning("Không tìm thấy thông tin nhân viên", "Lỗi");
        }
    }

    async Task LoadData(DateOnly? _)
    {
        if (Employee == null)
        {
            NotificationService.Warning("Không tìm thấy thông tin nhân viên", "Lỗi");
            return;
        }

        var client = HttpFactory.CreateClient("ApiClient");
        var response = await client.GetFromJsonAsync<List<OvertimeRequestDTO>>(
            $"api/overtime/history?empId={Employee.EmpId}&startDate={fromDate}&endDate={toDate}");

        if (response == null)
        {
            NotificationService.Warning("Không tìm thấy dữ liệu tăng ca", "Lỗi");
            return;
        }

        requests = response;
        StateHasChanged();
    }

    void Select(OvertimeRequestDTO item) => selected = item;

    void ShowAddModal()
    {
        newReqDate = DateOnly.FromDateTime(DateTime.Today);
        addVisible = true;
    }
    void HideAddModal() => addVisible = false;

    async Task Submit()
    {
        if (hours == null)
        {
            NotificationService.Warning("Không thể tìm thấy giờ.", "Lỗi");
            return;
        }

        if (selectedTypeId == null)
        {
            NotificationService.Warning("Chua chon loai tang cuong.", "Lỗi");
            return;
        }

        if (Employee == null)
        {
            NotificationService.Warning("Không thể tìm thấy thong tin nhan vien.", "Lỗi");
            return;
        }

        var request = new OvertimeRequest
            {
                EmpId = Employee.EmpId,
                ReqDate = newReqDate,
                StartTime = newStart,
                EndTime = newEnd,
                Hours = hours,
                Reason = newReason,
                Status = "Pending",
                OvertimeType = selectedTypeId
            };

        var client = HttpFactory.CreateClient("ApiClient");
        var res = await client.PostAsJsonAsync("api/overtime/request", request);

        if (!res.IsSuccessStatusCode)
        {
            NotificationService.Warning("Gửi thất bại.", "Lỗi");
            return;
        }

        NotificationService.Success("Đã gửi");
        addVisible = false;
        await LoadData(null);
    }


    decimal? hours;
    string hoursDisplay => hours?.ToString("0.##") ?? "0";

}
