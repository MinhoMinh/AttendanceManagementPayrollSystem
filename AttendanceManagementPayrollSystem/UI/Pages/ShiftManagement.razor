@page "/shift-management"
@using AttendanceManagementPayrollSystem.DTO
@inject IHttpClientFactory HttpFactory
@using Blazorise
@using Blazorise.Bootstrap5
@using Blazorise.Icons.FontAwesome

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    :root {
        --primary-cream: #FFE4A1;
        --primary-red: #97322D;
        --primary-red-dark: #7A2823;
        --primary-red-light: #B23D37;
    }

    .shift-management-wrapper {
        background: linear-gradient(135deg, #FFF8E7 0%, #FFF 100%);
        min-height: 100vh;
        padding: 2rem;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
        color: var(--primary-cream);
        padding: 1.5rem 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(151, 50, 45, 0.3);
        margin-bottom: 2rem;
    }

        .page-header h3 {
            margin: 0;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

    /* Custom Tabs */
    .blazorise .nav-tabs {
        border-bottom: 3px solid var(--primary-red);
        background: var(--primary-cream);
        padding: 0.5rem;
        border-radius: 10px 10px 0 0;
    }

        .blazorise .nav-tabs .nav-link {
            color: var(--primary-red);
            font-weight: 600;
            border: none;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }

            .blazorise .nav-tabs .nav-link:hover {
                background: rgba(151, 50, 45, 0.1);
                border-radius: 8px;
            }

            .blazorise .nav-tabs .nav-link.active {
                background: var(--primary-red);
                color: var(--primary-cream);
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(151, 50, 45, 0.3);
            }

    /* Tab Content */
    .tab-content {
        background: white;
        padding: 2rem;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* Section Headers */
    .section-header {
        background: linear-gradient(90deg, var(--primary-cream) 0%, rgba(255, 228, 161, 0.3) 100%);
        padding: 1rem 1.5rem;
        border-left: 5px solid var(--primary-red);
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

        .section-header h5 {
            margin: 0;
            color: var(--primary-red);
            font-weight: 600;
        }

    /* Buttons */
    .btn-custom-primary {
        background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
        color: var(--primary-cream);
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(151, 50, 45, 0.3);
    }

        .btn-custom-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(151, 50, 45, 0.4);
            background: linear-gradient(135deg, var(--primary-red-light) 0%, var(--primary-red) 100%);
            color: var(--primary-cream);
        }

    .btn-custom-outline {
        background: transparent;
        color: var(--primary-red);
        border: 2px solid var(--primary-red);
        padding: 0.5rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

        .btn-custom-outline:hover {
            background: var(--primary-red);
            color: var(--primary-cream);
            transform: translateY(-2px);
        }

    /* List Items */
    .shift-list-item {
        padding: 1rem;
        border: 2px solid transparent;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

        .shift-list-item:hover {
            border-color: var(--primary-cream);
            background: linear-gradient(90deg, rgba(255, 228, 161, 0.1) 0%, white 100%);
            transform: translateX(5px);
        }

        .shift-list-item.selected {
            background: linear-gradient(90deg, var(--primary-cream) 0%, rgba(255, 228, 161, 0.3) 100%);
            border-color: var(--primary-red);
            border-left: 5px solid var(--primary-red);
        }

        .shift-list-item strong {
            color: var(--primary-red);
            font-size: 1.1rem;
        }

    /* Tables */
    .table-custom {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

        .table-custom thead {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
            color: var(--primary-cream);
        }

            .table-custom thead th {
                border: none;
                padding: 1rem;
                font-weight: 600;
            }

        .table-custom tbody tr {
            transition: all 0.2s ease;
        }

            .table-custom tbody tr:hover {
                background: rgba(255, 228, 161, 0.2);
            }

        .table-custom tbody td {
            padding: 0.75rem 1rem;
            border-color: rgba(151, 50, 45, 0.1);
        }

    /* Scrollbar */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
    }

    .custom-scroll::-webkit-scrollbar-track {
        background: var(--primary-cream);
        border-radius: 10px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background: var(--primary-red);
        border-radius: 10px;
    }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--primary-red-dark);
        }

    /* Detail Panel */
    .detail-panel {
        background: linear-gradient(135deg, rgba(255, 228, 161, 0.1) 0%, white 100%);
        padding: 1.5rem;
        border-radius: 10px;
        border: 2px solid var(--primary-cream);
    }

        .detail-panel h5 {
            color: var(--primary-red);
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-cream);
        }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #999;
    }

        .empty-state i {
            font-size: 3rem;
            color: var(--primary-cream);
            margin-bottom: 1rem;
        }

    /* Badge */
    .badge-custom {
        background: var(--primary-red);
        color: var(--primary-cream);
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }

    /* Cards */
    .info-card {
        background: white;
        border: 2px solid var(--primary-cream);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

        .info-card:hover {
            border-color: var(--primary-red);
            box-shadow: 0 4px 12px rgba(151, 50, 45, 0.2);
        }

    .divider-custom {
        border-left: 3px solid var(--primary-cream);
    }
</style>

<div class="shift-management-wrapper">
    <div class="page-header">
        <h3><i class="bi bi-calendar-week"></i> Quản lý Lịch Làm việc</h3>
    </div>

    <Tabs @bind-SelectedTab="activeTab">
        <Items>
            <Tab Name="weekly"><i class="bi bi-calendar3"></i> Lịch Tuần</Tab>
            <Tab Name="daily"><i class="bi bi-clock"></i> Lịch Ngày</Tab>
            <Tab Name="department"><i class="bi bi-building"></i> Lịch Phòng Ban</Tab>
        </Items>

        <Content>
            <!-- TAB LỊCH NGÀY -->
            <TabPanel Name="daily">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-list-ul"></i> Danh sách Lịch Ngày</h5>
                    <button class="btn btn-custom-primary" @onclick="CreateDailyShift">
                        <i class="bi bi-plus-circle"></i> Tạo mới
                    </button>
                </div>
                <div class="row">
                    <!-- Danh sách bên trái -->
                    <div class="col-5 divider-custom">
                        <div class="custom-scroll" style="max-height:70vh; overflow-y:auto; padding-right: 1rem;">
                            @if (isLoadingDaily)
                            {
                                <div class="empty-state">
                                    <i class="bi bi-hourglass-split"></i>
                                    <p>Đang tải dữ liệu lịch ngày...</p>
                                </div>
                            }
                            else if (dailyShifts == null || !dailyShifts.Any())
                            {
                                <div class="empty-state">
                                    <i class="bi bi-inbox"></i>
                                    <p>Không có lịch ngày.</p>
                                </div>
                            }
                            else
                            {
                                @foreach (var item in dailyShifts)
                                {
                                    <div class="shift-list-item @(selectedDaily?.ShiftId == item.ShiftId ? "selected" : "")"
                                         @onclick="() => SelectDailyShift(item)">
                                        <strong>@item.ShiftName</strong>
                                        <small class="d-block text-muted mt-1">
                                            <i class="bi bi-info-circle"></i> @item.ShiftDescription
                                        </small>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- Chi tiết bên phải -->
                    <div class="col-7">
                        @if (selectedDaily != null)
                        {
                            <div class="detail-panel">
                                <h5><i class="bi bi-file-text"></i> Chi tiết: @selectedDaily.ShiftName</h5>
                                <table class="table table-custom table-bordered">
                                    <thead>
                                        <tr>
                                            <th><i class="bi bi-play-circle"></i> Bắt đầu</th>
                                            <th><i class="bi bi-stop-circle"></i> Kết thúc</th>
                                            <th><i class="bi bi-speedometer"></i> WorkUnits</th>
                                            <th><i class="bi bi-clock-history"></i> Giờ làm</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var seg in selectedDaily.Segments)
                                        {
                                            <tr>
                                                <td>@seg.StartTime</td>
                                                <td>@seg.EndTime</td>
                                                <td><span class="badge-custom">@seg.WorkUnits</span></td>
                                                <td>@seg.WorkHours</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <i class="bi bi-hand-index"></i>
                                <p>Chọn một lịch ngày để xem chi tiết.</p>
                            </div>
                        }
                    </div>
                </div>
            </TabPanel>

            <!-- TAB LỊCH TUẦN -->
            <TabPanel Name="weekly">
                <div class="section-header">
                    <h5><i class="bi bi-calendar3-week"></i> Lịch Tuần</h5>
                </div>

                @if (isLoadingWeekly)
                {
                    <div class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Đang tải dữ liệu lịch tuần...</p>
                    </div>
                }
                else if (weeklyShifts == null || !weeklyShifts.Any())
                {
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>Không có lịch tuần.</p>
                    </div>
                }
                else
                {
                    <Tabs @bind-SelectedTab="activeWeeklyShiftTab" Class="mb-3">
                        <Items>
                            @foreach (var weekShift in weeklyShifts)
                            {
                                <Tab Name="@weekShift.ShiftId.ToString()">@weekShift.ShiftName</Tab>
                            }
                        </Items>
                        <Content>
                            @foreach (var weekShift in weeklyShifts)
                            {
                                <TabPanel Name="@weekShift.ShiftId.ToString()">
                                    <div class="d-flex justify-content-end mb-3">
                                        <button class="btn btn-custom-primary" @onclick="() => OpenUpdateModal(weekShift)">
                                            <i class="bi bi-pencil-square"></i> Cập nhật lịch
                                        </button>
                                    </div>
                                    <div class="row">
                                        <!-- Trái: danh sách ngày trong tuần -->
                                        <div class="col-3 divider-custom">
                                            <div class="custom-scroll" style="max-height:70vh; overflow-y:auto; padding-right: 1rem;">
                                                @foreach (var day in weeklyDays)
                                                {
                                                    <div class="shift-list-item @(selectedWeekDay == day.Key ? "selected" : "")"
                                                         @onclick="() => SelectWeekDay(day.Key)">
                                                        <strong><i class="bi bi-calendar-day"></i> @day.Value</strong>
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <!-- Phải: chi tiết ca của ngày được chọn -->
                                        <div class="col-9">
                                            @if (selectedWeekDay != null)
                                            {
                                                var dailyShift = GetDailyShiftForDay(weekShift, selectedWeekDay);
                                                @if (dailyShift != null)
                                                {
                                                    <div class="detail-panel">
                                                        <h5>@dailyShift.ShiftName</h5>
                                                        <div class="info-card">
                                                            <p><strong><i class="bi bi-info-circle"></i> Mô tả:</strong> @dailyShift.ShiftDescription</p>
                                                            <p class="mb-0"><strong><i class="bi bi-calculator"></i> Tổng công:</strong> <span class="badge-custom">@dailyShift.ShiftWorkUnit</span></p>
                                                        </div>
                                                        <table class="table table-custom table-bordered">
                                                            <thead>
                                                                <tr>
                                                                    <th><i class="bi bi-play-circle"></i> Bắt đầu</th>
                                                                    <th><i class="bi bi-stop-circle"></i> Kết thúc</th>
                                                                    <th><i class="bi bi-speedometer"></i> WorkUnits</th>
                                                                    <th><i class="bi bi-clock-history"></i> Giờ làm</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var seg in dailyShift.Segments)
                                                                {
                                                                    <tr>
                                                                        <td>@seg.StartTime</td>
                                                                        <td>@seg.EndTime</td>
                                                                        <td><span class="badge-custom">@seg.WorkUnits</span></td>
                                                                        <td>@seg.WorkHours</td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="empty-state">
                                                        <i class="bi bi-calendar-x"></i>
                                                        <p>Chưa có ca cho ngày này.</p>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="empty-state">
                                                    <i class="bi bi-hand-index"></i>
                                                    <p>Chọn một ngày để xem chi tiết.</p>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </TabPanel>
                            }
                        </Content>
                    </Tabs>
                }
            </TabPanel>

            <TabPanel Name="department">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-buildings"></i> Danh sách Lịch Phòng Ban</h5>
                    <button class="btn btn-custom-primary" @onclick="OpenDepartmentModal">
                        <i class="bi bi-pencil-square"></i> Cập nhật
                    </button>
                </div>

                @if (isLoadingDepartment)
                {
                    <div class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Đang tải dữ liệu phòng ban...</p>
                    </div>
                }
                else if (departmentShifts == null || !departmentShifts.Any())
                {
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>Không có dữ liệu.</p>
                    </div>
                }
                else
                {
                    <table class="table table-custom table-bordered">
                        <thead>
                            <tr>
                                <th><i class="bi bi-building"></i> Phòng ban</th>
                                <th><i class="bi bi-calendar-range"></i> Shift</th>
                                <th><i class="bi bi-check-circle"></i> Active</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in departmentShifts)
                            {
                                <tr>
                                    <td><strong>@item.DepName</strong></td>
                                    <td>@item.ShiftName</td>
                                    <td>
                                        @if (item.IsActive)
                                        {
                                            <span class="badge-custom"><i class="bi bi-check-lg"></i> Active</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted"><i class="bi bi-x-lg"></i> Inactive</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </TabPanel>

        </Content>
    </Tabs>
</div>

<!-- ✅ SỬ DỤNG MODAL COMPONENT MỚI -->
<UpdateWeeklyShiftModal @bind-IsVisible="isUpdateModalVisible"
                        WeekShift="currentWeekShift"
                        DailyShifts="dailyShifts"
                        OnSaved="HandleModalSaved" />

<CreateDailyShiftModal @bind-IsVisible="isCreateDailyModalVisible"
                       OnSaved="HandleDailyShiftCreated" />

<UpdateDepartmentShiftModal @bind-IsVisible="isDepartmentModalVisible"
                            DepartmentShifts="departmentShifts"
                            Shifts="shifts"
                            OnSaved="HandleDepartmentSaved" />


@code {
    private string activeWeeklyShiftTab = string.Empty;
    private string? selectedWeekDay;
    private string activeTab = "weekly";

    private List<DailyShiftViewDTO>? dailyShifts;
    private List<WeeklyShiftViewDTO>? weeklyShifts;

    private DailyShiftViewDTO? selectedDaily;
    private WeeklyShiftViewDTO? selectedWeekly;

    private bool isLoadingDaily = true;
    private bool isLoadingWeekly = true;

    private bool isUpdateModalVisible = false;
    private WeeklyShiftViewDTO? currentWeekShift;

    private bool isCreateDailyModalVisible = false;

    private List<DepartmentWeeklyShiftViewDTO>? departmentShifts;
    private bool isLoadingDepartment = true;
    private bool isDepartmentModalVisible = false;
    private List<WeeklyShiftViewDTO>? shifts;

    private readonly Dictionary<string, string> weeklyDays = new()
    {
        { "mon", "Thứ 2" },
        { "tue", "Thứ 3" },
        { "wed", "Thứ 4" },
        { "thu", "Thứ 5" },
        { "fri", "Thứ 6" },
        { "sat", "Thứ 7" },
        { "sun", "Chủ nhật" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDailyShifts();
        await LoadWeeklyShifts();
        await LoadDepartmentShifts();
    }

    private async Task LoadDepartmentShifts()
    {
        try
        {
            var client = HttpFactory.CreateClient("ApiClient");
            departmentShifts = await client.GetFromJsonAsync<List<DepartmentWeeklyShiftViewDTO>>("api/departmentweeklyshift");
            shifts = await client.GetFromJsonAsync<List<WeeklyShiftViewDTO>>("api/shift/weeklyshiftlist");
        }
        catch
        {
            departmentShifts = new();
            shifts = new();
        }
        finally
        {
            isLoadingDepartment = false;
        }
    }

    private void OpenDepartmentModal()
    {
        isDepartmentModalVisible = true;
    }

    private async Task LoadDailyShifts()
    {
        try
        {
            var client = HttpFactory.CreateClient("ApiClient");
            dailyShifts = await client.GetFromJsonAsync<List<DailyShiftViewDTO>>("api/shift/dailyshiftlist");
            selectedDaily = dailyShifts?.FirstOrDefault();
        }
        catch
        {
            dailyShifts = new();
        }
        finally
        {
            isLoadingDaily = false;
        }
    }

    private async Task LoadWeeklyShifts()
    {
        try
        {
            var client = HttpFactory.CreateClient("ApiClient");
            weeklyShifts = await client.GetFromJsonAsync<List<WeeklyShiftViewDTO>>("api/shift/weeklyshiftlist");
            selectedWeekly = weeklyShifts?.FirstOrDefault();

            if (weeklyShifts != null && weeklyShifts.Any())
            {
                activeWeeklyShiftTab = weeklyShifts.First().ShiftId.ToString();
            }
        }
        catch
        {
            weeklyShifts = new();
        }
        finally
        {
            isLoadingWeekly = false;
        }
    }

    private void OpenUpdateModal(WeeklyShiftViewDTO weekShift)
    {
        currentWeekShift = weekShift;
        isUpdateModalVisible = true;
    }

    private async Task HandleModalSaved()
    {
        await LoadWeeklyShifts();
        Console.WriteLine("✅ Cập nhật thành công!");
    }

    private async Task HandleDailyShiftCreated()
    {
        await LoadDailyShifts();
        Console.WriteLine("✅ Tạo lịch ngày thành công!");
    }

    private async Task HandleDepartmentSaved()
    {
        await LoadDepartmentShifts();
        Console.WriteLine("✅ Cập nhật phòng ban thành công!");
    }

    private void SelectWeekDay(string dayKey)
    {
        selectedWeekDay = dayKey;
    }

    private void SelectDailyShift(DailyShiftViewDTO dto) => selectedDaily = dto;
    private void SelectWeeklyShift(WeeklyShiftViewDTO dto) => selectedWeekly = dto;

    private async Task CreateDailyShift()
    {
        isCreateDailyModalVisible = true;
    }

    private async Task CreateWeeklyShift()
    {
        // TODO: Implement
    }

    private DailyShiftViewDTO? GetDailyShiftForDay(WeeklyShiftViewDTO weekShift, string day)
    {
        return day switch
        {
            "mon" => weekShift.MonDailyShift,
            "tue" => weekShift.TueDailyShift,
            "wed" => weekShift.WedDailyShift,
            "thu" => weekShift.ThuDailyShift,
            "fri" => weekShift.FriDailyShift,
            "sat" => weekShift.SatDailyShift,
            "sun" => weekShift.SunDailyShift,
            _ => null
        };
    }
}