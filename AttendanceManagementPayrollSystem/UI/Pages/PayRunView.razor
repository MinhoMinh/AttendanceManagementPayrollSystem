@page "/payruns/{id:int}"
@using AttendanceManagementPayrollSystem.DTO
@using System.Text.Json
@using AttendanceManagementPayrollSystem.UI.Components
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject IHttpClientFactory HttpFactory

<h3>Pay Run View</h3>

@if (isLoading)
{
    <p>Đang tải...</p>
}
else if (loadError)
{
    <div class="alert alert-danger">Không thể tải dữ liệu của đợt tính lương.</div>
}
else if (payRun is null)
{
    <div class="alert alert-warning">Không tìm thấy dữ liệu cho đợt tính lương này.</div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Chi tiết đợt tính lương</h4>
        @if (canApproveFirst || canApproveFinal)
        {
            <div class="btn-group">
                <button class="btn btn-success" @onclick="ShowConfirmModal">Xác nhận</button>
                <button class="btn btn-danger" @onclick="ShowRejectModal">Từ chối</button>
            </div>
        }
    </div>

    <div class="row">
        <div class="col-2">
            <PayRunDetails PayRun="@payRun" />
        </div>

        <div class="col-6">
            <PayRunItemList Groups="@groups"
                            OnItemSelected="@SelectItem" />
        </div>

        <div class="col-4">
            <PayRunItemDetails Item="@selectedItem" />
        </div>
    </div>
}

@if (showApprovalModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận đợt tính lương</h5>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xác nhận đợt tính lương này?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelConfirm">Hủy</button>
                    <button class="btn btn-success" @onclick="ConfirmPayRun">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showRejectModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Từ chối đợt tính lương</h5>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn từ chối đợt tính lương này?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelReject">Hủy</button>
                    <button class="btn btn-danger" @onclick="RejectPayRun">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public int Id { get; set; }

    private PayRunDto? payRun;
    private PayRunItemDto? selectedItem;
    private EmployeeDTO? employee;
    private bool isLoading = true;
    private bool loadError = false;

    private bool showApprovalModal = false;
    private bool showRejectModal = false;
    private bool canApproveFirst = false;
    private bool canApproveFinal = false;

    Dictionary<string, List<PayRunItemDto>>? groups;

    private void SelectItem(PayRunItemDto item) => selectedItem = item;

    [Inject] INotificationService NotificationService { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpFactory.CreateClient("ApiClient");
            var response = await client.GetAsync($"api/pay-run/{Id}");

            if (response.IsSuccessStatusCode)
            {
                payRun = await response.Content.ReadFromJsonAsync<PayRunDto>();
                var employeesByDep =
                    await client.GetFromJsonAsync<Dictionary<string, List<EmployeeBasicDTO>>>(
                        "api/department/employees-by-dep");

                groups =
                    employeesByDep.ToDictionary(
                        kv => kv.Key,
                        kv =>
                            payRun.PayRunItems
                            .Where(x => kv.Value.Any(e => e.EmpId == x.EmpId))
                            .ToList()
                    );

                // items not in group
                var unassigned = payRun.PayRunItems
                    .Where(x => !employeesByDep.Values.SelectMany(e => e).Any(e => e.EmpId == x.EmpId))
                    .ToList();

                if (unassigned.Count > 0)
                    groups["Unknown"] = unassigned;

                var emptyKeys = groups
                    .Where(kv => kv.Value == null || kv.Value.Count == 0)
                    .Select(kv => kv.Key)
                    .ToList();

                foreach (var key in emptyKeys)
                    groups.Remove(key);
            }
            else
                loadError = true;
        }
        catch (Exception ex)
        {
            NotificationService.Warning(ex.Message, "Lỗi");
            loadError = true;
        }
        finally
        {
            isLoading = false;
            await CheckPermissions();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            var empJson = await JS.InvokeAsync<string>("localStorage.getItem", "employee");

            if (!string.IsNullOrWhiteSpace(empJson))
            {
                employee = JsonSerializer.Deserialize<EmployeeDTO>(empJson);
                await CheckPermissions();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Warning($"Lỗi khi kiểm tra quyền hạn: {ex.Message}", "Lỗi");
            Console.Error.WriteLine($"Permission check error: {ex.Message}");
        }
    }

    private async Task CheckPermissions()
    {
        if (employee == null || payRun == null) return;

        if (employee.Permissions.Contains("approve_payroll_run_first") && payRun.Status == "Pending")
            canApproveFirst = true;
        else if (employee.Permissions.Contains("approve_payroll_run_final") && payRun.Status == "FirstApproved")
            canApproveFinal = true;

        await InvokeAsync(StateHasChanged);
    }

    private void ShowConfirmModal() => showApprovalModal = true;
    private void CancelConfirm() => showApprovalModal = false;

    private void ShowRejectModal() => showRejectModal = true;
    private void CancelReject() => showRejectModal = false;

    private async Task ConfirmPayRun()
    {
        await HandleApproval("approve");
    }

    private async Task RejectPayRun()
    {
        await HandleApproval("reject");
    }

    private async Task HandleApproval(string action)
    {
        showApprovalModal = false;
        showRejectModal = false;

        if (employee == null || payRun == null)
        {
            NotificationService.Warning($"Không thể tìm thấy nhân viên hoặc bảng lương", "Lỗi");
            return;
        }

        try
        {
            string apiUrl = action switch
            {
                "approve" => canApproveFirst
                    ? "api/pay-run/approve-first"
                    : canApproveFinal
                        ? "api/pay-run/approve-final"
                        : string.Empty,
                "reject" => "api/pay-run/reject",
                _ => string.Empty
            };

            if (string.IsNullOrEmpty(apiUrl))
            {
                NotificationService.Warning($"Bạn không có quyện hạn để thực hiện hành động này", "Lỗi");
                return;
            }

            var client = HttpFactory.CreateClient("ApiClient");
            var request = new { ApproverId = employee.EmpId, PayRunId = payRun.PayrollRunId };
            var response = await client.PostAsJsonAsync(apiUrl, request);

            if (response.IsSuccessStatusCode)
            {
                string msg = action == "approve" ? "Đã duyệt bảng lương thành công." : "Đã từ chối bảng lương.";

                NotificationService.Success($"msg");
                await Task.Delay(3000);
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            else
            {
                var details = await response.Content.ReadAsStringAsync();
                NotificationService.Warning($"msg", "Lỗi");

            }
        }
        catch (Exception ex)
        {
            NotificationService.Warning($"Exception: {ex.Message}", "Lỗi");
        }
    }
}
