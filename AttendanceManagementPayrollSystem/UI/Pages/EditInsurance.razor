@page "/edit-insurance"
@using AttendanceManagementPayrollSystem.DTO
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@using System.Globalization

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
    .page-wrapper {
        background: linear-gradient(135deg, #FFE4A1 0%, #fff8e1 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .page-header {
        background: linear-gradient(135deg, #97322D 0%, #b23d31 100%);
        color: #FFE4A1;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(151, 50, 45, 0.3);
        margin-bottom: 30px;
        border: none;
    }

        .page-header .btn-outline-secondary {
            border-color: #FFE4A1;
            color: #FFE4A1;
            background: transparent;
        }

            .page-header .btn-outline-secondary:hover {
                background-color: #FFE4A1;
                color: #97322D;
                border-color: #FFE4A1;
            }

    .insurance-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(151, 50, 45, 0.1);
        border: 2px solid #FFE4A1;
    }

        .insurance-card h5 {
            color: #97322D;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 10px;
            border-bottom: 3px solid #FFE4A1;
            margin-bottom: 0;
        }

    .btn-outline-success {
        border-color: #97322D;
        color: #97322D;
        background: transparent;
    }

        .btn-outline-success:hover {
            background-color: #97322D;
            color: #FFE4A1;
            border-color: #97322D;
        }

    .table-container {
        max-height: 300px;
        overflow-y: auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #FFE4A1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #97322D;
            border-radius: 4px;
        }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: #7a2824;
            }

    .table-light {
        background: linear-gradient(135deg, #97322D 0%, #b23d31 100%) !important;
        color: #FFE4A1 !important;
    }

        .table-light th {
            border: none !important;
            font-weight: 600;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(135deg, #97322D 0%, #b23d31 100%) !important;
            color: #FFE4A1 !important;
        }

    .table tbody tr {
        transition: all 0.1s ease;
    }

        .table tbody tr:hover {
            background-color: #97322D;
            transform: translateX(0.5px);
        }

    .table-info {
        background-color: #FFE4A1 !important;
    }

    .table-warning {
        background-color: #ffe4a1 !important;
    }

    .table-success {
        background-color: #d4edda !important;
    }

    .table-secondary {
        background-color: #e9ecef !important;
    }

    .btn-sm.btn-success {
        background-color: #97322D;
        border-color: #97322D;
        color: #FFE4A1;
    }

        .btn-sm.btn-success:hover {
            background-color: #7a2824;
            border-color: #7a2824;
        }

    .btn-sm.btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-sm.btn-outline-primary {
        border-color: #97322D;
        color: #97322D;
    }

        .btn-sm.btn-outline-primary:hover {
            background-color: #97322D;
            color: #FFE4A1;
            border-color: #97322D;
        }

    .btn-sm.btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

        .btn-sm.btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }

    .btn-sm.btn-outline-warning {
        border-color: #97322D;
        color: #97322D;
    }

        .btn-sm.btn-outline-warning:hover {
            background-color: #FFE4A1;
            color: #97322D;
            border-color: #FFE4A1;
        }

    .form-control {
        border: 2px solid #FFE4A1;
        border-radius: 6px;
    }

        .form-control:focus {
            border-color: #97322D;
            box-shadow: 0 0 0 0.2rem rgba(151, 50, 45, 0.15);
        }

    .modal-content {
        border-radius: 12px;
        border: 3px solid #FFE4A1;
        box-shadow: 0 10px 40px rgba(151, 50, 45, 0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #97322D 0%, #b23d31 100%);
        color: #FFE4A1;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-header .modal-title {
            color: #FFE4A1;
        }

    .modal .btn-danger {
        background-color: #97322D;
        border-color: #97322D;
    }

        .modal .btn-danger:hover {
            background-color: #7a2824;
            border-color: #7a2824;
        }

    .loading-message {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(151, 50, 45, 0.1);
        border: 2px solid #FFE4A1;
    }
</style>

<div class="page-wrapper">
    <h3 class="page-header d-flex justify-content-between align-items-center">
        <span>Lịch sử tỷ lệ bảo hiểm</span>
        <button class="btn btn-sm btn-outline-secondary" @onclick="BackToRatesTax">
            <i class="bi bi-arrow-left"></i> Quay lại
        </button>
    </h3>

    @if (groups == null)
    {
        <div class="loading-message">
            <p><em>Đang tải dữ liệu tỷ lệ bảo hiểm...</em></p>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(successMessage) && showToast)
        {
            <div class="toast-fixed">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i> @successMessage
                    <button type="button" class="btn-close" @onclick="() => showToast = false"></button>
                </div>
            </div>
        }

        @foreach (var group in groups)
        {
            <div class="insurance-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-uppercase fw-bold mb-0">@group.Category</h5>
                    <button class="btn btn-sm btn-outline-success" @onclick="() => StartAdd(group.Category)">
                        <i class="bi bi-plus-circle"></i> Thêm mới
                    </button>
                </div>
                <div class="table-container">
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Tên loại</th>
                                <th>Tỷ lệ nhân viên</th>
                                <th>Tỷ lệ công ty</th>
                                <th>Quy tắc trần</th>
                                <th>Hiệu lực từ</th>
                                <th>Hiệu lực đến</th>
                                <th>Mã luật</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (isAdding && group.Category == editModel.Category)
                            {
                                <tr class="table-info">
                                    <td><input class="form-control" @bind="editModel.TypeName" /></td>
                                    <td><input class="form-control" type="number" step="0.01" @bind="editModel.EmployeeRate" /></td>
                                    <td><input class="form-control" type="number" step="0.01" @bind="editModel.EmployerRate" /></td>
                                    <td><input class="form-control" @bind="editModel.CapRule" /></td>
                                    <td><input type="date" class="form-control" @bind-value="editModel.EffectiveFrom" @bind-value:format="yyyy-MM-dd" /></td>
                                    <td><input type="date" class="form-control" @bind-value="editModel.EffectiveTo" @bind-value:format="yyyy-MM-dd" /></td>
                                    <td><input class="form-control" @bind="editModel.LawCode" /></td>
                                    <td>-</td>
                                    <td class="text-nowrap">
                                        <button class="btn btn-sm btn-success me-1" @onclick="SaveAdd"><i class="bi bi-check-lg"></i> Lưu</button>
                                        <button class="btn btn-sm btn-secondary" @onclick="CancelAdd"><i class="bi bi-x-lg"></i> Hủy</button>
                                    </td>
                                </tr>
                            }
                            @foreach (var item in group.Upcoming)
                            {
                                @RowContent(item, "Upcoming")
                            }

                            @foreach (var item in group.Active)
                            {
                                @RowContent(item, "Active")
                            }

                            @foreach (var item in group.Inactive)
                            {
                                @RowContent(item, "Inactive")
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<InsuranceRateGroupDTO>? groups;
    private InsuranceRateDTO? selectedItem;
    private InsuranceRateEditDTO editModel = new();
    private bool isEditing = false;
    private bool isAdding = false;
    private string? successMessage;
    private bool showToast = false;

    //Confirm
    private bool showConfirm = false;
    private string? confirmMessage;
    private Func<Task>? onConfirmAction;

    private void StartAdd(string category)
    {
        selectedItem = null;
        isEditing = false;
        isAdding = true;

        editModel = new InsuranceRateEditDTO
        {
            Category = category,
            EffectiveFrom = DateOnly.FromDateTime(DateTime.Today),
            EffectiveTo = null,
            IsActive = false
        };
    }

    private void ShowConfirm(string message, Func<Task> action)
    {
        confirmMessage = message;
        onConfirmAction = action;
        showConfirm = true;
    }

    private void CancelConfirm()
    {
        showConfirm = false;
        confirmMessage = null;
        onConfirmAction = null;
    }

    private async Task ConfirmAction()
    {
        showConfirm = false;
        if (onConfirmAction != null)
            await onConfirmAction.Invoke();
    }
    //Confirm

    protected override async Task OnInitializedAsync()
    {
        var client = HttpFactory.CreateClient("ApiClient");
        groups = await client.GetFromJsonAsync<List<InsuranceRateGroupDTO>>("api/insurancerateset/group");
    }

    private RenderFragment RowContent(InsuranceRateDTO item, string status) => @<tr class="@GetRowClass(status)">
@if (isEditing && selectedItem?.RateSetId == item.RateSetId)
    {
    <td><input class="form-control" @bind="editModel.TypeName" /></td>
    <td><input class="form-control" type="number" step="0.01" @bind="editModel.EmployeeRate" /></td>
    <td><input class="form-control" type="number" step="0.01" @bind="editModel.EmployerRate" /></td>
    <td><input class="form-control" @bind="editModel.CapRule" /></td>
    <td><input type="date" class="form-control" @bind-value="editModel.EffectiveFrom" @bind-value:format="yyyy-MM-dd" /></td>
    <td><input type="date" class="form-control" @bind-value="editModel.EffectiveTo" @bind-value:format="yyyy-MM-dd" /></td>
    <td><input class="form-control" @bind="editModel.LawCode" /></td>
    <td>
        @{
                DateOnly now = DateOnly.FromDateTime(DateTime.Now);
            string statusText;
                if (!item.IsActive && (now<item.EffectiveFrom || (now > item.EffectiveFrom && item.EffectiveTo<now)))
                statusText = "Không có hiệu lực";
                else if (!item.IsActive && now > item.EffectiveTo)
                statusText = "Hết hiệu lực";
                else
                statusText = "Đang được áp dụng";
                }
        @statusText
    </td>
    <td class="text-nowrap">
        <button class="btn btn-sm btn-success me-1" @onclick="SaveEdit">Lưu</button>
        <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Hủy</button>
    </td>
    }
    else
{
        <td>@item.TypeName</td>
        <td>@(item.EmployeeRate * 100)%</td>
        <td>@(item.EmployerRate * 100)%</td>
        <td>@item.CapRule</td>
        <td>@item.EffectiveFrom.ToString("yyyy-MM-dd")</td>
        <td>@(item.EffectiveTo?.ToString("yyyy-MM-dd") ?? "-")</td>
        <td>@item.LawCode</td>
        <td>
            @{
                DateOnly now = DateOnly.FromDateTime(DateTime.Now);
                string statusText;
                if (!item.IsActive && (now < item.EffectiveFrom || (now > item.EffectiveFrom && item.EffectiveTo > now)))
                    statusText = "Không có hiệu lực";
                else if (!item.IsActive && (now > item.EffectiveTo || item.EffectiveFrom < now))
                    statusText = "Hết hiệu lực";
                else
                    statusText = "Đang được áp dụng";
            }
            @statusText
        </td>

        <td>
            @if (status == "Upcoming")
            {
                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEdit(item)">
                    <i class="bi bi-pencil-square"></i> Sửa
                </button>
                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteUpcoming(item.RateSetId)">
                    <i class="bi bi-trash"></i> Xóa
                </button>
            }
            else
            {
                <button class="btn btn-sm btn-outline-warning" @onclick="() => ToggleStatus(item)">
                    <i class="bi bi-toggle2-@(item.IsActive ? "on" : "off")"></i>
                    @(item.IsActive ? "Ngừng hoạt động" : "Kích hoạt")
                </button>
            }
        </td>
}
</tr>;


private string GetRowClass(string status) => status switch
{
    "Inactive" => "table-secondary",
    "Active" => "table-success",
    "Upcoming" => "table-warning",
    _ => ""
};

private void StartEdit(InsuranceRateDTO item)
{
    selectedItem = item;
    editModel = new InsuranceRateEditDTO
    {
        RateSetId = item.RateSetId,
        TypeName = item.TypeName,
        EmployeeRate = item.EmployeeRate,
        EmployerRate = item.EmployerRate,
        CapRule = item.CapRule,
        EffectiveFrom = item.EffectiveFrom,
        EffectiveTo = item.EffectiveTo,
        LawCode = item.LawCode,
        IsActive = item.IsActive,
        Category = item.Category
    };
    isEditing = true;
}

private async Task SaveAdd()
{
    var client = HttpFactory.CreateClient("ApiClient");
    var response = await client.PostAsJsonAsync("api/insurancerateset", editModel);

    successMessage = response.IsSuccessStatusCode ? "Thêm mới thành công." : "Thêm mới thất bại.";
    showToast = true;
    isAdding = false;

    groups = await client.GetFromJsonAsync<List<InsuranceRateGroupDTO>>("api/insurancerateset/group");
}

private void CancelAdd()
{
    isAdding = false;
    editModel = new();
}


private void CancelEdit()
{
    isEditing = false;
    selectedItem = null;
}

private async Task SaveEdit()
{
    var client = HttpFactory.CreateClient("ApiClient");
    var response = await client.PutAsJsonAsync($"api/insurancerateset/upcoming/{editModel.RateSetId}", editModel);

    if (response.IsSuccessStatusCode)
    {
        successMessage = "Cập nhật thành công.";
        showToast = true;
        isEditing = false;
        groups = await client.GetFromJsonAsync<List<InsuranceRateGroupDTO>>("api/insurancerateset/group");
    }
    else
    {
        successMessage = "Lưu thất bại.";
        showToast = true;
    }
}

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    // Tự động ẩn Toast sau 3 giây
    if (showToast)
    {
        await Task.Delay(3000);
        showToast = false;
        StateHasChanged();
    }
}

private async Task DeleteUpcoming(int id)
{
    ShowConfirm($"Bạn có chắc muốn xóa bản ghi ID {id}?", async () =>
    {
        var client = HttpFactory.CreateClient("ApiClient");
        var response = await client.DeleteAsync($"api/insurancerateset/upcoming/{id}");

        successMessage = response.IsSuccessStatusCode ? "Xóa bản ghi thành công." : "Xóa thất bại.";
        showToast = true;
        groups = await client.GetFromJsonAsync<List<InsuranceRateGroupDTO>>("api/insurancerateset/group");
    });
}

private async Task ToggleStatus(InsuranceRateDTO item)
{
    var newStatus = !item.IsActive;
    ShowConfirm($"Bạn có chắc muốn {(newStatus ? "kích hoạt" : "ngừng")} loại bảo hiểm '{item.TypeName}'?", async () =>
    {
        var client = HttpFactory.CreateClient("ApiClient");
        var response = await client.PutAsJsonAsync($"api/insurancerateset/{item.RateSetId}/status", newStatus);

        successMessage = response.IsSuccessStatusCode ? "Cập nhật trạng thái thành công." : "Cập nhật thất bại.";
        showToast = true;
        groups = await client.GetFromJsonAsync<List<InsuranceRateGroupDTO>>("api/insurancerateset/group");
    });
}



private void BackToRatesTax() => Navigation.NavigateTo("/rates-tax");
}
@if (showConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận</h5>
                    <button type="button" class="btn-close" @onclick="CancelConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>@confirmMessage</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelConfirm">Hủy</button>
                    <button class="btn btn-danger" @onclick="ConfirmAction">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
}