@page "/bonus-create"

@using AttendanceManagementPayrollSystem.DTO
@inject IHttpClientFactory HttpFactory
@inject NavigationManager NavigationManager
@using System.Linq

<PageTitle>Tạo thưởng mới</PageTitle>

<Layout>
    <Container Class="mt-4">
        <Card Class="p-4 shadow-sm">
            <CardHeader>
                <h4 class="mb-0">🎁 Tạo thưởng mới</h4>
            </CardHeader>

            <CardBody>
                <EditForm Model="@bonus" OnValidSubmit="@CreateBonus">
                    <DataAnnotationsValidator />
                    <Blazorise.ValidationSummary />

                    <!-- Tên thưởng -->
                    <Row Class="mb-3">
                        <Column>
                            <Field>
                                <Label>Tên thưởng</Label>
                                <InputText @bind-Value="bonus.BonusName" class="form-control"
                                           placeholder="Nhập tên thưởng (VD: Thưởng năng suất, Thưởng Tết)" />
                            </Field>
                        </Column>
                    </Row>

                    <!-- Số tiền thưởng -->
                    <Row Class="mb-3">
                        <Column>
                            <Field>
                                <Label>Số tiền thưởng</Label>
                                <NumericEdit TValue="decimal" @bind-Value="bonus.BonusAmount" />
                            </Field>
                        </Column>
                    </Row>

                    <!-- Ngày áp dụng (Bonus_Period) -->
                    <Row Class="mb-3">
                        <Column>
                            <Field>
                                <Label>Ngày áp dụng</Label>
                                <InputDate @bind-Value="bonus.BonusPeriod"
                                           class="form-control"
                                           min="2024-01-01"
                                           max="2030-12-31" />
                                <FieldHelp>
                                    Chọn ngày đại diện cho kỳ thưởng (ví dụ: 2025-09-01 cho Thưởng Quốc Khánh).
                                </FieldHelp>
                            </Field>
                        </Column>
                    </Row>

                    <!-- Nút hành động -->
                    <Row>
                        <Column>
                            <div class="d-flex gap-2 mt-3">
                                <Button Color="Color.Primary" Size="Size.Medium" Type="ButtonType.Submit">
                                    <i class="bi bi-plus-circle"></i> Tạo thưởng
                                </Button>
                                <Button Color="Color.Secondary" Size="Size.Medium" Clicked="@BackToList">
                                    <i class="bi bi-arrow-left"></i> Quay lại danh sách
                                </Button>
                            </div>
                        </Column>
                    </Row>
                </EditForm>

                @if (!string.IsNullOrEmpty(message))
                {
                    <Alert Color="@(isError? Color.Danger: Color.Success)" Class="mt-3" Visible="true">
                        <strong>@message</strong>
                    </Alert>
                }
            </CardBody>
        </Card>
    </Container>
</Layout>

@code {
    private BonusCreateRequest bonus = new()
    {
        BonusName = "",
        BonusAmount = 0,
        BonusPeriod = DateTime.Today
    };

    private string? message;
    private bool isError = false;

    private async Task CreateBonus()
    {
        try
        {
            // Reset thông báo trước khi gửi request
            message = null;
            isError = false;

            var client = HttpFactory.CreateClient("default");

            // Đảm bảo BaseAddress được set
            if (client.BaseAddress == null)
            {
                client.BaseAddress = new Uri(NavigationManager.BaseUri);
            }

            var res = await client.PostAsJsonAsync("api/bonus/create", bonus);

            if (res.IsSuccessStatusCode)
            {
                message = "✅ Bạn đã tạo bonus thành công!";
                isError = false;

                // Reset form để tạo bonus mới
                bonus = new BonusCreateRequest
                {
                    BonusName = "",
                    BonusAmount = 0,
                    BonusPeriod = DateTime.Today
                };

                // Force UI update
                StateHasChanged();
            }
            else
            {
                var errorContent = await res.Content.ReadAsStringAsync();
                message = $"⚠️ Có lỗi xảy ra: {res.StatusCode} - {errorContent}";
                isError = true;
            }
        }
        catch (HttpRequestException httpEx)
        {
            message = $"❌ Lỗi kết nối API: {httpEx.Message}";
            isError = true;
        }
        catch (Exception ex)
        {
            message = $"❌ Lỗi hệ thống: {ex.Message}";
            isError = true;
        }
    }

    private void BackToList() => NavigationManager.NavigateTo("/bonus-manager");
}