@page "/attendance/self"
@using AttendanceManagementPayrollSystem.UI.Components
@using Blazorise

@using System.Net.Http.Json
@using AttendanceManagementPayrollSystem.DTO
@using BlazorCalendar
@using BlazorCalendar.Models
@using System.Text.Json
@inject IHttpClientFactory HttpFactory
@inject IJSRuntime JS

<PageTitle>Lịch tổng hợp</PageTitle>

<style>
    .header-card {
        background: linear-gradient(135deg, #FFE4A1 0%, #FFF5DC 100%);
        border: 2px solid #97322D;
        border-radius: 8px;
    }

    .calendar-card {
        border: 2px solid #FFE4A1;
        border-radius: 8px;
    }

    .calendar-card .card-header {
        background-color: #97322D;
        color: white;
        font-weight: bold;
    }

    .detail-card {
        background-color: #FFF9F0;
        border: 2px solid #97322D;
        border-radius: 8px;
    }

    .detail-card .card-header {
        background-color: #FFE4A1;
        color: #97322D;
        font-weight: bold;
        border-bottom: 2px solid #97322D;
    }

    .field-label {
        color: #97322D;
        font-weight: 600;
    }

    .picker-container .form-control {
        border: 2px solid #FFE4A1;
    }

    .picker-container .form-control:focus {
        border-color: #97322D;
        box-shadow: 0 0 0 0.2rem rgba(151, 50, 45, 0.25);
    }

    .employee-info {
        background-color: #FFE4A1;
        padding: 10px 15px;
        border-radius: 6px;
        color: #97322D;
        font-weight: 600;
        margin-bottom: 15px;
    }
</style>

<Card Class="header-card">
    <CardBody>
        <Div Class="d-flex flex-row align-items-start gap-3">
            <Field>
                <FieldLabel Class="field-label">Xem theo</FieldLabel>
                <Select TValue="DisplayedView" @bind-SelectedValue="SelectedView">
                    <SelectItem Value="DisplayedView.Annual">Theo năm</SelectItem>
                    <SelectItem Value="DisplayedView.Monthly">Theo tháng</SelectItem>
                </Select>
            </Field>


            @if (SelectedView == DisplayedView.Monthly)
            {
                <Field>
                    <FieldLabel Class="field-label">Chọn tháng/năm</FieldLabel>
                    <FieldBody>
                        <Div Class="d-flex flex-column picker-container" Position="Position.Relative">
                        <Blazorise.DatePicker TValue="DateTime?"
                                    Date="@SelectedDate"
                                        DateChanged="@(value => OnMonthlyDateChanged(value))"
                                    DisplayFormat="MM/yyyy" />
                        </Div>
                    </FieldBody>
                </Field>

                <Field>
                    <FieldLabel Class="field-label">Loại hiển thị</FieldLabel>
                    <FieldBody>
                        <Div Class="d-flex flex-row align-items-center gap-3">
                            <Check TValue="bool" @bind-Checked="ShowCongMonthly">Công</Check>
                            <Check TValue="bool" @bind-Checked="ShowGioVuotMonthly">Giờ vượt</Check>
                            <Check TValue="bool" @bind-Checked="ShowNgayNghiMonthly">Ngày nghỉ</Check>
                            <Check TValue="bool" @bind-Checked="ShowNgayLeMonthly">Ngày lễ</Check>
                        </Div>
                    </FieldBody>
                </Field>
        }
        else if (SelectedView == DisplayedView.Annual)
        {
            <Div Class="d-flex flex-row align-items-start gap-2">
                <Field>
                    <FieldLabel Class="field-label">Ngày bắt đầu</FieldLabel>
                    <FieldBody>
                        <Div Class="d-flex flex-column picker-container" Position="Position.Relative">
                            <Blazorise.DatePicker TValue="DateTime?"
                                        Date="@SelectedDate"
                                            DateChanged="@(value => OnAnnualDateChanged(value))"
                                        DisplayFormat="dd/MM/yyyy" />
                        </Div>
                    </FieldBody>
                    <FieldHelp>Format: DD/MM/YYYY</FieldHelp>
                </Field>
                <Field>
                    <FieldLabel Class="field-label">Số tháng hiển thị</FieldLabel>
                    <NumericEdit TValue="int" @bind-Value="MonthsToDisplay" Min="1" Max="12" />
                </Field>
            </Div>

                <Field>
                    <FieldLabel Class="field-label">Loại hiển thị</FieldLabel>
                    <RadioGroup TValue="string"
                                CheckedValue="@AnnualViewType"
                                CheckedValueChanged="@OnAnnualViewTypeChanged">
                        <Radio Value="@("Cong")">Công</Radio>
                        <Radio Value="@("GioVuot")">Giờ vượt</Radio>
                        <Radio Value="@("NgayNghi")">Ngày nghỉ</Radio>
                        <Radio Value="@("NgayLe")">Ngày lễ</Radio>
                    </RadioGroup>
                </Field>
        }
        </Div>
    </CardBody>
</Card>

<div class="row mt-3">
    <!-- Left: Calendar view -->
    <div class="col-md-10 col-12">
        <Card Class="calendar-card">
            <CardHeader>Lịch</CardHeader>
            <CardBody>
                <!-- Optional info above calendar -->
                <div class="employee-info">
                    <strong>Nhân viên:</strong> @Employee?.EmpName
                </div>

                <CalendarContainer DisplayedView="SelectedView" FirstDate="@SelectedDate" TasksList="@ShownTasks.ToArray()">
                    <AnnualView Months="@MonthsToDisplay" TaskClick="ViewDay" />
                    <MonthlyView TaskClick="ViewDay" />
                </CalendarContainer>
            </CardBody>
        </Card>
    </div>

    <!-- Right: Day details -->
    <div class="col-md-2 col-12 mt-2 mt-md-0">
        <Card Class="detail-card">
            <CardHeader>Chi tiết ngày</CardHeader>
            <CardBody>
                @if (SelectedDay != null)
                {
                    <div>
                        <p style="color: #97322D; font-weight: 600;"><strong>Ngày:</strong> @SelectedDay.Value.ToString("dd/MM/yyyy")</p>

                        @if (DayClockins != null && DayClockins.Any())
                        {
                            <div class="d-flex flex-column gap-2">
                                @foreach (var comp in DayClockins.Take(3))
                                {
                                    <ClockinDayView Component="@comp" OnReportClicked="OpenReportModal" />
                                }

                            </div>
                        }

                        @if (DayHolidays != null && DayHolidays.Any())
                        {
                            <div class="d-flex flex-column gap-2">
                                @foreach (var comp in DayHolidays)
                                {
                                    <DepartmentHolidayView HolidayInfo="@comp" />
                                }

                            </div>
                        }

                        @if (DayOvertimes != null && DayOvertimes.Any())
                        {
                            <div class="d-flex flex-column gap-2">
                                @foreach (var comp in DayOvertimes)
                                {
                                    <OvertimeRequestView Component="@comp" />
                                }

                            </div>
                        }
                        
                    </div>
                }
                else
                {
                    <p style="color: #97322D;">Chọn một ngày để xem chi tiết</p>
                }
            </CardBody>
        </Card>
    </div>

</div>

<ClockinReportModal @ref="reportModal" />

@code {
    private DisplayedView _selectedView = DisplayedView.Annual;
    private DisplayedView SelectedView
    {
        get => _selectedView;
        set
        {
            if (_selectedView == value)
                return;

            _selectedView = value;
            OnSelectedViewChanged(value);
        }
    }

    private List<Tasks> ShownTasks = new();

    private DateTime today = DateTime.Today;
    private DateTime SelectedDate = DateTime.Today;
    private DateTime? SelectedDay;
    private int _monthsToDisplay = 8;
    private int MonthsToDisplay
    {
        get => _monthsToDisplay;
        set
        {
            if (_monthsToDisplay == value)
                return;

            var oldValue = _monthsToDisplay;
            _monthsToDisplay = value;

            OnMonthsToDisplayChanged(oldValue, value);
        }
    }

    private string AnnualViewType = "Cong";


    private void OnMonthsToDisplayChanged(int oldValue, int newValue)
    {
        if (newValue > oldValue)
            LoadMonthlyData();
    }

    private EmployeeDTO? Employee;
    private ClockinDTO? MonthlyClockin;
    private List<HolidayCalendarDTO>? MonthlyHolidays = new();
    private List<OvertimeRequestDTO>? MonthlyOvertimes = new();

    private List<ClockinDTO>? AnnualClockins = new();
    private List<HolidayCalendarDTO>? AnnualHolidays = new();
    private List<OvertimeRequestDTO>? AnnualOvertimes = new();

    //private Dictionary<DateTime, DailyDetailDTO> DayData = new();
    //private Dictionary<DateTime, ClockinComponentDto> ComponentData = new();

    [Inject] INotificationService NotificationService { get; set; }


    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            var empJson = await JS.InvokeAsync<string>("localStorage.getItem", "employee");
            if (string.IsNullOrWhiteSpace(empJson))
            {
                NotificationService.Warning("Không thể tìm thấy thông tin nhân viên!", "Lỗi");
                return;
            }
            ;

            Employee = JsonSerializer.Deserialize<EmployeeDTO>(empJson);
            StateHasChanged();
        }
    }

    Task OnAnnualViewTypeChanged(string value)
    {
        AnnualViewType = value;

        SetAnnualData();

        return Task.CompletedTask;
    }

    private async Task OnMonthlyDateChanged(DateTime? value)
    {
        var newDate = value ?? DateTime.Today;
        var normalized = new DateTime(newDate.Year, newDate.Month, 1);

        bool monthChanged =
             SelectedDate.Month != normalized.Month
            || SelectedDate.Year != normalized.Year;

        SelectedDate = normalized;


        if (monthChanged)
            await LoadMonthlyData();
    }

    private async Task OnAnnualDateChanged(DateTime? value)
    {
        var newDate = value ?? DateTime.Today;
        var normalized = new DateTime(newDate.Year, newDate.Month, newDate.Day);

        bool monthChanged =
             SelectedDate.Month != normalized.Month
            || SelectedDate.Year != normalized.Year;

        SelectedDate = normalized;

        if (monthChanged)
            await LoadAnnualData();
    }

    private void OnSelectedViewChanged(DisplayedView newValue)
    {
        if (newValue == DisplayedView.Annual)
        {
            SetAnnualData();
        }
        else if (newValue == DisplayedView.Monthly)
        {
            SetMonthlyData();
        }
    }

    private async Task LoadMonthlyData()
    {
        if (Employee == null)
        {
            NotificationService.Warning("Không tìm thấy thông tin nhân viên!", "Lỗi");
            return;
        }
        ;

        var client = HttpFactory.CreateClient("ApiClient");

        //Clockins
        var response = await client.GetFromJsonAsync<ClockinDTO>($"api/clockin/employee?empId={Employee.EmpId}&month={SelectedDate.Month}&year={SelectedDate.Year}");
        if (response == null)
        {
            NotificationService.Warning("Không tìm thấy thông tin chấm công của nhân viên!", "Lỗi");
            return;
        }

        MonthlyClockin = response;


        //holiday
        var monthStart = new DateTime(SelectedDate.Year, SelectedDate.Month, 1);
        var monthEnd = monthStart.AddMonths(1).AddDays(-1);

        var holidays = await client.GetFromJsonAsync<IEnumerable<HolidayCalendarDTO>>(
            $"/api/holidaycalendar/employee/{Employee.EmpId}/range?start={monthStart:O}&end={monthEnd:O}");

        MonthlyHolidays = holidays?.ToList() ?? new();

        //overtime
        string startStr = monthStart.ToString("yyyy-MM-dd");
        string endStr = monthEnd.ToString("yyyy-MM-dd");

        var overtimes = await client.GetFromJsonAsync<IEnumerable<OvertimeRequestDTO>>(
            $"/api/overtime/history?empId={Employee.EmpId}&startDate={startStr}&endDate={endStr}");

        MonthlyOvertimes = overtimes?.ToList() ?? new();


        SetMonthlyData();
    }

    private async Task LoadAnnualData()
    {
        if (Employee == null)
        {
            NotificationService.Warning("Không tìm thấy thông tin nhân viên!", "Lỗi");
            return;
        };

        var client = HttpFactory.CreateClient("ApiClient");

        // clockins
        var response = await client.GetFromJsonAsync<IEnumerable<ClockinDTO>>($"/api/clockin/employee/period?employeeId={Employee.EmpId}&startDate={SelectedDate}&months={MonthsToDisplay}");

        if (response == null)
        {
            NotificationService.Warning("Không tìm thấy thông tin chấm công của nhân viên!", "Lỗi");
            return;
        }
        AnnualClockins = response.ToList();

        // holidays
        var endDate = SelectedDate.AddMonths(MonthsToDisplay);
        var response2 = await client.GetFromJsonAsync<IEnumerable<HolidayCalendarDTO>>(
            $"/api/holidaycalendar/employee/{Employee.EmpId}/range?start={SelectedDate:O}&end={endDate:O}");

        if (response2 == null)
        {
            NotificationService.Warning("Không tìm thấy lịch nghỉ của nhân viên!", "Lỗi");
            return;
        }
        AnnualHolidays = response2.ToList();

        //overtimes 
        var monthStart = new DateTime(SelectedDate.Year, SelectedDate.Month, 1);
        string startStr = monthStart.ToString("yyyy-MM-dd");
        string endStr = endDate.ToString("yyyy-MM-dd");

        var overtimes = await client.GetFromJsonAsync<IEnumerable<OvertimeRequestDTO>>(
            $"/api/overtime/history?empId={Employee.EmpId}&startDate={startStr}&endDate={endStr}");

        AnnualOvertimes = overtimes?.ToList() ?? new();

        SetAnnualData();
    }

    private async Task SetAnnualData()
    {
        ShownTasks.Clear();
        int id = 1;

        switch (AnnualViewType)
        {
            case "Cong":
                if (AnnualClockins != null)
                    foreach (var clockin in AnnualClockins)
                    {
                        foreach (var record in clockin.DailyRecords)
                        {
                            if (record.ScheduledHour != null)
                            {
                                bool isFull = (record.ActualHour ?? 0m) >= (record.ScheduledHour ?? 0m);
                                string color = isFull ? "#90EE90" : "#FFB6C1";

                                ShownTasks.Add(new Tasks
                                    {
                                        ID = id++,
                                        DateStart = new DateTime(clockin.Date.Year, clockin.Date.Month, record.Day),
                                        DateEnd = new DateTime(clockin.Date.Year, clockin.Date.Month, record.Day),
                                        Code = $"Giờ làm: {(record.ActualHour ?? 0m):F2}/{(record.ScheduledHour ?? 0m):F2}",
                                        Caption = "Lorem ipsum dolor sit amet",
                                        Color = color,
                                    });
                            }
                        }
                    }
                break;

            case "GioVuot":
                if (AnnualOvertimes != null)
                    foreach (var overtime in AnnualOvertimes)
                    {
                        ShownTasks.Add(new Tasks
                            {
                                ID = id++,
                                DateStart = overtime.ReqDate.ToDateTime(overtime.StartTime ?? TimeOnly.MinValue),
                                DateEnd = overtime.ReqDate.ToDateTime(overtime.EndTime ?? TimeOnly.MinValue),
                                Code = $"Giờ vượt",
                                Caption = "Lorem ipsum dolor sit amet",
                                Color = "lightgreen"
                            });
                    }
                break;

            case "NgayNghi":

                break;

            case "NgayLe":
                if (AnnualHolidays != null)
                    foreach (var holiday in AnnualHolidays)
                    {
                        if (holiday.DepartmentHolidays.Count == 0) continue;

                        var depholiday = holiday.DepartmentHolidays[0];
                        ShownTasks.Add(new Tasks
                            {
                                ID = id++,
                                DateStart = new DateTime(depholiday.StartDate.Year, depholiday.StartDate.Month, depholiday.StartDate.Day),
                                DateEnd = new DateTime(depholiday.EndDate.Year, depholiday.EndDate.Month, depholiday.EndDate.Day),
                                Code = $"Nghỉ lễ: {depholiday.HolidayName}",
                                Caption = "Lorem ipsum dolor sit amet",
                                Color = "lightblue"
                            });
                    }

                break;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task SetMonthlyData()
    {
        if (MonthlyClockin == null) return;

        ShownTasks.Clear();
        int id = 1;

        // Công (work hours)
        if (ShowCongMonthly)
        {
            foreach (var r in MonthlyClockin.DailyRecords.Where(r => r.ScheduledHour != null))
            {
                bool isFull = (r.ActualHour ?? 0m) >= (r.ScheduledHour ?? 0m);
                ShownTasks.Add(new Tasks
                    {
                        ID = id++,
                        DateStart = new DateTime(MonthlyClockin.Date.Year, MonthlyClockin.Date.Month, r.Day),
                        DateEnd = new DateTime(MonthlyClockin.Date.Year, MonthlyClockin.Date.Month, r.Day),
                        Code = $"Giờ làm: {(r.ActualHour ?? 0m):F2}/{(r.ScheduledHour ?? 0m):F2}",
                        Caption = "",
                        Color = isFull ? "#90EE90" : "#FFB6C1"
                    });
            }
        }

        // ngay le
        if (ShowNgayLeMonthly && MonthlyHolidays != null)
            foreach (var holiday in MonthlyHolidays)
            {
                if (holiday.DepartmentHolidays.Count == 0) continue;

                var depholiday = holiday.DepartmentHolidays[0];
                ShownTasks.Add(new Tasks
                    {
                        ID = id++,
                        DateStart = new DateTime(depholiday.StartDate.Year, depholiday.StartDate.Month, depholiday.StartDate.Day),
                        DateEnd = new DateTime(depholiday.EndDate.Year, depholiday.EndDate.Month, depholiday.EndDate.Day),
                        Code = $"Nghỉ lễ: {depholiday.HolidayName}",
                        Caption = "Lorem ipsum dolor sit amet",
                        Color = "lightblue"
                    });
            }

        //overtime
        if (ShowGioVuotMonthly && MonthlyOvertimes != null)
            foreach (var overtime in MonthlyOvertimes)
            {
                ShownTasks.Add(new Tasks
                    {
                        ID = id++,
                        DateStart = overtime.ReqDate.ToDateTime(overtime.StartTime ?? TimeOnly.MinValue),
                        DateEnd = overtime.ReqDate.ToDateTime(overtime.EndTime ?? TimeOnly.MinValue),
                        Code = $"Giờ vượt",
                        Caption = "Lorem ipsum dolor sit amet",
                        Color = "lightgreen"
                    });
            }


        await InvokeAsync(StateHasChanged);
    }


    private List<ClockinComponentDto> DayClockins = new();
    private List<DepartmentHolidayCalendarDTO> DayHolidays = new();
    private List<OvertimeRequestDTO> DayOvertimes = new();

    private async Task ViewDay(ClickTaskParameter taskParams)
    {
        SelectedDay = taskParams.Day;

        DayClockins.Clear();
        DayHolidays.Clear();
        DayOvertimes.Clear();

        if (SelectedView == DisplayedView.Monthly)
        {
            LoadDayMonthly();
        }
        else if (SelectedView == DisplayedView.Annual)
        {
            LoadDayAnnual();
        }

        await InvokeAsync(StateHasChanged);
    }

    private void LoadDayMonthly()
    {
        if (MonthlyClockin == null || SelectedDay == null)
        {
            //NotificationService.Warning("empty or null", "Lỗi");
            return;
        }
        else
        {
            //NotificationService.Warning($"{SelectedDay.Value}", "Lỗi");
        }

        if (ShowCongMonthly)
            DayClockins = MonthlyClockin.Components
                .Where(c => c.Date.HasValue && c.Date.Value.Date == SelectedDay.Value.Date)
                .Take(3)
                .ToList();

        if (ShowNgayLeMonthly && MonthlyHolidays != null)
            DayHolidays = MonthlyHolidays
                .SelectMany(h => h.DepartmentHolidays)
                .Where(dh => dh.StartDate.Date <= SelectedDay.Value.Date &&
                                dh.EndDate.Date >= SelectedDay.Value.Date)
                .ToList();

        if (ShowGioVuotMonthly && MonthlyOvertimes != null)
        {
            var selectedday = DateOnly.FromDateTime(SelectedDay.Value);

            DayOvertimes = MonthlyOvertimes
                .Where(o => o.ReqDate == selectedday)
                .ToList();
        }

    }

    private void LoadDayAnnual()
    {
        if (SelectedDay == null) return;

        // Cong + GioVuot: use clockins
        if (AnnualViewType == "Cong" && AnnualClockins != null)
        {
            DayClockins = AnnualClockins
                .SelectMany(c => c.Components)
                .Where(c => c.Date.HasValue && c.Date.Value.Date == SelectedDay.Value.Date)
                .Take(3)
                .ToList();
        }

        // NgayLe + NgayNghi: use holidays
        if ((AnnualViewType == "NgayLe" || AnnualViewType == "NgayNghi") && AnnualHolidays != null)
        {
            DayHolidays = AnnualHolidays
                .SelectMany(h => h.DepartmentHolidays)
                .Where(dh => dh.StartDate.Date <= SelectedDay.Value.Date &&
                             dh.EndDate.Date >= SelectedDay.Value.Date)
                .ToList();
        }

        if (AnnualViewType == "GioVuot" && AnnualOvertimes != null)
        {
            var selectedday = DateOnly.FromDateTime(SelectedDay.Value);

            DayOvertimes = AnnualOvertimes
                .Where(o => o.ReqDate == selectedday)
                .ToList();
        }
    }

    private bool _showCongMonthly = true;
    private bool ShowCongMonthly
    {
        get => _showCongMonthly;
        set
        {
            _showCongMonthly = value;
            SetMonthlyData();
        }
    }

    private bool _showGioVuotMonthly;
    private bool ShowGioVuotMonthly
    {
        get => _showGioVuotMonthly;
        set
        {
            _showGioVuotMonthly = value;
            SetMonthlyData();
        }
    }

    private bool _showNgayLeMonthly;
    private bool ShowNgayLeMonthly
    {
        get => _showNgayLeMonthly;
        set
        {
            _showNgayLeMonthly = value;
            SetMonthlyData();
        }
    }

    private bool _showNgayNghiMonthly;
    private bool ShowNgayNghiMonthly
    {
        get => _showNgayNghiMonthly;
        set
        {
            _showNgayNghiMonthly = value;
            SetMonthlyData();
        }
    }

    
    private ClockinReportModal? reportModal;

    private async Task OpenReportModal(ClockinComponentDto comp)
    {
        if (reportModal != null)
            await reportModal.ShowAsync(comp);
        else
            NotificationService.Warning("ReportModal chưa được khởi tạo!", "Lỗi");
    }
}
