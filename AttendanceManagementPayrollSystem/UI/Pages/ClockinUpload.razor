@page "/xlsupload"
@using System.Net.Http.Json
@using AttendanceManagementPayrollSystem.Services.Helper
@using ExcelDataReader
@using AttendanceManagementPayrollSystem.DTO
@using AttendanceManagementPayrollSystem.Models
@using System.Data
@inject IHttpClientFactory ClientFactory

<h3>Upload XLS</h3>

<InputFile OnChange="UploadFile" accept=".xls" />

@if (!string.IsNullOrEmpty(Status))
{
    <p>@Status</p>
}

@if (Clockins != null && Clockins.Any())
{
    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-primary btn-sm" @onclick="Generate">Generate</button>
    </div>

    <h4>Processed Clockins</h4>

    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th></th>
                <th>EmpId</th>
                <th>Date</th>
                <th>WorkUnits</th>
                <th>Scheduled</th>
                <th>ClockLog</th>
                <th>Work Breakdown</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in Clockins)
            {
                var isExpanded = expandedRows.Contains(c.EmpId);

                <tr>
                    <td>
                        <button class="btn btn-sm btn-link" @onclick="() => ToggleRow(c.EmpId)">
                            @(isExpanded ? "−" : "+")
                        </button>
                    </td>
                    <td>@c.EmpId</td>
                    <td>@c.Date.ToString("yyyy-MM-dd")</td>
                    <td>@c.WorkUnits</td>
                    <td>@c.ScheduledUnits</td>
                    <td>@c.ClockLog</td>
                    <td>@c.WorkUnitBreakdown</td>
                </tr>

                @if (isExpanded && c.DailyRecords != null && c.DailyRecords.Any())
                {
                    <tr>
                        <td></td>
                        <td colspan="6">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Logs</th>
                                        <th>Actual</th>
                                        <th>Scheduled</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var d in c.DailyRecords)
                                    {
                                        <tr>
                                            <td>@d.Day</td>
                                            <td>@string.Join(", ", d.Logs)</td>
                                            <td>@(d.ActualUnit ?? 0m).ToString("F2")</td>
                                            <td>@(d.ScheduledUnit ?? 0m).ToString("F2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}


@code {
    private string Status = "";
    private List<ClockinDTO>? Clockins;

    const int MAX_FILESIZE = 5_000 * 1024;

    [Inject] INotificationService NotificationService { get; set; }

    // public async Task UploadFile(InputFileChangeEventArgs e)
    // {
    //     var file = e.File;
    //     if (file == null) return;

    //     try
    //     {
    //         using var mem = new MemoryStream();
    //         using var stream = file.OpenReadStream(MAX_FILESIZE);
    //         await stream.CopyToAsync(mem);
    //         mem.Position = 0;

    //         using var client = ClientFactory.CreateClient("ApiClient");

    //         using var content = new StreamContent(mem);
    //         content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/vnd.ms-excel");
    //         var response = await client.PostAsync("api/clockin/uploadxls", content);


    //         var content = new MultipartFormDataContent();
    //         content.Add(new StreamContent(mem), "file", file.Name);

    //         var response = await client.PostAsync("api/clockin/uploadxls", content);

    //         if (response.IsSuccessStatusCode)
    //         {
    //             Clockins = await response.Content.ReadFromJsonAsync<List<ClockinDTO>>();
    //             Status = "File processed successfully";
    //         }
    //         else
    //         {
    //             Status = $"Upload failed: {response.StatusCode}";
    //         }
    //     }
    //     catch (Exception ex)
    //     {
    //         Status = ex.Message;
    //     }
    // }

    private HashSet<int> expandedRows = new();

    private void ToggleRow(int empId)
    {
        if (expandedRows.Contains(empId))
            expandedRows.Remove(empId);
        else
            expandedRows.Add(empId);
    }

    private async Task Generate()
    {
        if (Clockins == null || !Clockins.Any())
        {
            Status = "No clock-in data to upload.";
            NotificationService.Warning("Không thể tìm thấy thông tin!", "Lỗi");
            return;
        }

        try
        {
            using var client = ClientFactory.CreateClient("ApiClient");
            var response = await client.PostAsJsonAsync("api/clockin/upload-clockin", Clockins);

            if (response.IsSuccessStatusCode)
                NotificationService.Success("Cập nhật thông tin thành công!");
            else
                NotificationService.Warning($"{response.ReasonPhrase}", "Lỗi");
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
    }

    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        var file = e.File;

        using var stream = file.OpenReadStream(long.MaxValue);
        using var mem = new MemoryStream();
        await stream.CopyToAsync(mem);
        mem.Position = 0;

        System.Text.Encoding.RegisterProvider(
            System.Text.CodePagesEncodingProvider.Instance);

        using var reader = ExcelReaderFactory.CreateReader(mem);
        var result = reader.AsDataSet();

        // Table[2] = third sheet
        var table = ConvertToTransfer(result.Tables[2]);


        using var client = ClientFactory.CreateClient("ApiClient");
        var response = await client.PostAsJsonAsync("api/clockin/upload-table", table);

        var responseContent = await response.Content.ReadAsStringAsync();

        if (response.IsSuccessStatusCode)
        {
            Clockins = await response.Content.ReadFromJsonAsync<List<ClockinDTO>>();

            if (Clockins == null)
                NotificationService.Warning("Trả về danh sách rỗng.", "Lỗi");
            else
                NotificationService.Warning("Xử lý thành công.", "Thông báo");
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            NotificationService.Warning($"{response.StatusCode} - {error}", "Lỗi");
        }

    }

    private TableTransfer ConvertToTransfer(DataTable table)
    {
        return new TableTransfer
            {
                Columns = table.Columns.Cast<DataColumn>().Select(c => c.ColumnName).ToList(),
                Rows = table.Rows.Cast<DataRow>()
                        .Select(r => r.ItemArray.Select(x => x?.ToString() ?? "").ToList())
                        .ToList()
            };
    }

}
