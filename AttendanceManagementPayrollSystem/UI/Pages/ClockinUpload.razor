@page "/xlsupload"
@using System.Net.Http.Json
@using AttendanceManagementPayrollSystem.Services.Helper
@using ExcelDataReader
@using AttendanceManagementPayrollSystem.DTO
@using AttendanceManagementPayrollSystem.Models
@using System.Data
@inject IHttpClientFactory ClientFactory

<h3>Tải lên tệp XLS</h3>

<InputFile OnChange="UploadFile" accept=".xls" />

@if (!string.IsNullOrEmpty(Status))
{
    <p>@Status</p>
}

@if (Clockins != null && Clockins.Any())
{
    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-primary btn-sm" @onclick="Generate">Tạo dữ liệu</button>
    </div>

    <h4>Dữ liệu chấm công đã xử lý</h4>

    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th></th>
                <th>Mã NV</th>
                <th>Tháng</th>
                <th>Đơn vị làm việc</th>
                <th>Đơn vị kế hoạch</th>
                <th>Nhật ký chấm công</th>
                <th>Chi tiết đơn vị</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in Clockins)
            {
                var isExpanded = expandedRows.Contains(c.EmpId);

                <tr>
                    <td>
                        <button class="btn btn-sm btn-link" @onclick="() => ToggleRow(c.EmpId)">
                            @(isExpanded ? "−" : "+")
                        </button>
                    </td>
                    <td>@c.EmpId</td>
                    <td>@c.Date.ToString("yyyy-MM")</td>
                    <td>@(c.WorkUnits?.ToString("F2") ?? "0.00")</td>
                    <td>@(c.ScheduledUnits?.ToString("F2") ?? "0.00")</td>
                    <td>@c.ClockLog</td>
                    <td>@c.WorkUnitBreakdown</td>
                </tr>

                @if (isExpanded)
                {
                    <tr>
                        <td></td>
                        <td colspan="6">

                            <!-- Daily Records -->
                            @if (c.DailyRecords != null && c.DailyRecords.Any())
                            {
                                <h6>Bảng chi tiết theo ngày</h6>
                                <table class="table table-sm mb-3">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Nhật ký</th>
                                            <th>Thực tế</th>
                                            <th>Kế hoạch</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var d in c.DailyRecords)
                                        {
                                            <tr>
                                                <td>@d.Day</td>
                                                <td>@string.Join(", ", d.Logs)</td>
                                                <td>@((d.ActualUnit ?? 0m).ToString("F2"))</td>
                                                <td>@((d.ScheduledUnit ?? 0m).ToString("F2"))</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }

                            <!-- Components -->
                            @if (c.Components != null && c.Components.Any())
                            {
                                <h6>Thành phần chấm công</h6>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ca</th>
                                            <th>Ngày</th>
                                            <th>Giờ vào</th>
                                            <th>Giờ ra</th>
                                            <th>Nhật ký</th>
                                            <th>Mô tả</th>
                                            <th>Giờ làm</th>
                                            <th>Giờ kế hoạch</th>
                                            <th>Đơn vị làm việc</th>
                                            <th>Đơn vị kế hoạch</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var comp in c.Components)
                                        {
                                            <tr>
                                                <td>@comp.Shift</td>
                                                <td>@comp.Date?.ToString("yyyy-MM-dd")</td>
                                                <td>@comp.CheckIn?.ToString("HH:mm")</td>
                                                <td>@comp.CheckOut?.ToString("HH:mm")</td>
                                                <td>@comp.ClockinLog</td>
                                                <td>@comp.Description</td>
                                                <td>@(comp.WorkHours?.ToString("F2") ?? "")</td>
                                                <td>@(comp.ScheduledHours?.ToString("F2") ?? "")</td>
                                                <td>@(comp.WorkUnits?.ToString("F2") ?? "")</td>
                                                <td>@(comp.ScheduledUnits?.ToString("F2") ?? "")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }

                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}


@code {
    private string Status = "";
    private List<ClockinDTO>? Clockins;

    const int MAX_FILESIZE = 5_000 * 1024;

    [Inject] INotificationService NotificationService { get; set; }


    private HashSet<int> expandedRows = new();

    private void ToggleRow(int empId)
    {
        if (expandedRows.Contains(empId))
            expandedRows.Remove(empId);
        else
            expandedRows.Add(empId);
    }

    private async Task Generate()
    {
        if (Clockins == null || !Clockins.Any())
        {
            Status = "No clock-in data to upload.";
            NotificationService.Warning("Không thể tìm thấy thông tin!", "Lỗi");
            return;
        }

        try
        {
            using var client = ClientFactory.CreateClient("ApiClient");
            var response = await client.PostAsJsonAsync("api/clockin/upload-clockin", Clockins);

            if (response.IsSuccessStatusCode)
                NotificationService.Success("Cập nhật thông tin thành công!");
            else
                NotificationService.Warning($"{response.ReasonPhrase}", "Lỗi");
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
    }

    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        var file = e.File;

        using var stream = file.OpenReadStream(long.MaxValue);
        using var mem = new MemoryStream();
        await stream.CopyToAsync(mem);
        mem.Position = 0;

        System.Text.Encoding.RegisterProvider(
            System.Text.CodePagesEncodingProvider.Instance);

        using var reader = ExcelReaderFactory.CreateReader(mem);
        var result = reader.AsDataSet();

        // Table[2] = third sheet
        var table = ConvertToTransfer(result.Tables[2]);


        using var client = ClientFactory.CreateClient("ApiClient");
        var response = await client.PostAsJsonAsync("api/clockin/upload-table", table);

        var responseContent = await response.Content.ReadAsStringAsync();

        if (response.IsSuccessStatusCode)
        {
            Clockins = await response.Content.ReadFromJsonAsync<List<ClockinDTO>>();

            if (Clockins == null)
                NotificationService.Warning("Trả về danh sách rỗng.", "Lỗi");
            else
                NotificationService.Warning("Xử lý thành công.", "Thông báo");
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            NotificationService.Warning($"{response.StatusCode} - {error}", "Lỗi");
        }

    }

    private TableTransfer ConvertToTransfer(DataTable table)
    {
        return new TableTransfer
            {
                Columns = table.Columns.Cast<DataColumn>().Select(c => c.ColumnName).ToList(),
                Rows = table.Rows.Cast<DataRow>()
                        .Select(r => r.ItemArray.Select(x => x?.ToString() ?? "").ToList())
                        .ToList()
            };
    }

}
